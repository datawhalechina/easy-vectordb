<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Annoy入门与环境搭建 | EasyVecDB 教程</title>
    <meta name="description" content="向量数据库学习与实战指南">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/easy-vecdb/assets/style.7PZEV1Fm.css" as="style">
    <link rel="preload stylesheet" href="/easy-vecdb/vp-icons.css" as="style">
    
    <script type="module" src="/easy-vecdb/assets/app.BWmjF2Cf.js"></script>
    <link rel="preload" href="/easy-vecdb/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/easy-vecdb/assets/chunks/theme.DvNcO5PS.js">
    <link rel="modulepreload" href="/easy-vecdb/assets/chunks/framework.CzE6cJJL.js">
    <link rel="modulepreload" href="/easy-vecdb/assets/Annoy_chapter1_Annoy入门与环境搭建.md.C86TB_kz.lean.js">
    <link rel="icon" href="/easy-vecdb/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><div class="announcement-banner">⚠️ Alpha内测版本警告：此为早期内部构建版本，尚不完整且可能存在错误，欢迎大家提Issue反馈问题或建议。</div><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/easy-vecdb/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/easy-vecdb/favicon.ico" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>EasyVecDB 教程</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/base/chapter1/%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>向量基础</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/easy-vecdb/Annoy/chapter1/Annoy%E5%85%A5%E9%97%A8%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Annoy 教程</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/Faiss/chapter1/FAISS%E5%85%A5%E9%97%A8%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Faiss 教程</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/Milvus/chapter1/Milvus%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A5%E9%97%A8.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Milvus 教程</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/more/chapter5/%E5%90%91%E9%87%8F.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>补充内容</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/easy-vecdb/projects/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>实战项目</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/easy-vecdb" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/datawhalechina/easy-vecdb" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 has-active" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>Chapter 1 · Annoy入门与环境搭建</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/easy-vecdb/Annoy/chapter1/Annoy%E5%85%A5%E9%97%A8%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>Annoy入门与环境搭建</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>Chapter 2 · Annoy核心API详解</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/easy-vecdb/Annoy/chapter2/Annoy%E6%A0%B8%E5%BF%83API%E8%AF%A6%E8%A7%A3.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>Annoy核心API详解</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>Chapter 3 · Annoy进阶技巧与最佳实践</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/easy-vecdb/Annoy/chapter3/Annoy%E8%BF%9B%E9%98%B6%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>Annoy进阶技巧与最佳实践</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _easy-vecdb_Annoy_chapter1_Annoy%E5%85%A5%E9%97%A8%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA" data-v-39a288b8><div><h1 id="annoy入门与环境搭建" tabindex="-1">Annoy入门与环境搭建 <a class="header-anchor" href="#annoy入门与环境搭建" aria-label="Permalink to &quot;Annoy入门与环境搭建&quot;">​</a></h1><h2 id="_1-annoy-简介" tabindex="-1">1. Annoy 简介 <a class="header-anchor" href="#_1-annoy-简介" aria-label="Permalink to &quot;1. Annoy 简介&quot;">​</a></h2><p><strong>Annoy</strong>（Approximate Nearest Neighbors Oh Yeah）是由 <strong>Spotify</strong> 开发并开源的轻量级近似最近邻搜索库。它被广泛应用于 Spotify 的音乐推荐系统中，用于快速查找相似的歌曲和用户。</p><h3 id="核心优势" tabindex="-1">核心优势 <a class="header-anchor" href="#核心优势" aria-label="Permalink to &quot;核心优势&quot;">​</a></h3><table tabindex="0"><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>内存映射（mmap）</strong></td><td>索引文件可以通过内存映射加载，不需要将整个索引加载到内存中</td></tr><tr><td><strong>多进程共享</strong></td><td>多个进程可以共享同一份索引文件，极大降低内存开销</td></tr><tr><td><strong>API 简洁</strong></td><td>只有几个核心方法，5 分钟即可上手</td></tr><tr><td><strong>跨平台</strong></td><td>支持 Python、C++、Java、Go 等多种语言绑定</td></tr></tbody></table><h3 id="适用场景" tabindex="-1">适用场景 <a class="header-anchor" href="#适用场景" aria-label="Permalink to &quot;适用场景&quot;">​</a></h3><p>Annoy 特别适合以下场景：</p><ul><li><strong>单机部署</strong>：不需要分布式架构</li><li><strong>只读索引</strong>：数据不频繁更新，可以定期重建</li><li><strong>数据量中等</strong>：百万到千万级向量</li><li><strong>多进程服务</strong>：Web 服务需要多个 worker 共享索引</li></ul><h3 id="不适用场景" tabindex="-1">不适用场景 <a class="header-anchor" href="#不适用场景" aria-label="Permalink to &quot;不适用场景&quot;">​</a></h3><ul><li>需要频繁增删改的场景（Annoy 不支持增量更新）</li><li>需要分布式部署的超大规模数据（考虑 Milvus）</li><li>需要丰富索引类型和 GPU 加速（考虑 Faiss）</li></ul><hr><h2 id="_2-环境安装" tabindex="-1">2. 环境安装 <a class="header-anchor" href="#_2-环境安装" aria-label="Permalink to &quot;2. 环境安装&quot;">​</a></h2><h3 id="_2-1-pip-安装-推荐" tabindex="-1">2.1 pip 安装（推荐） <a class="header-anchor" href="#_2-1-pip-安装-推荐" aria-label="Permalink to &quot;2.1 pip 安装（推荐）&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-2-conda-安装" tabindex="-1">2.2 conda 安装 <a class="header-anchor" href="#_2-2-conda-安装" aria-label="Permalink to &quot;2.2 conda 安装&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conda</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> conda-forge</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-annoy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-3-验证安装" tabindex="-1">2.3 验证安装 <a class="header-anchor" href="#_2-3-验证安装" aria-label="Permalink to &quot;2.3 验证安装&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annoy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建一个简单的索引测试</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annoy.AnnoyIndex(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;angular&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t.add_item(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t.add_item(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t.add_item(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t.build(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 搜索测试</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t.get_nns_by_vector([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;搜索结果: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Annoy 安装成功！&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>运行上述代码，如果输出类似以下内容，说明安装成功：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>搜索结果: [0, 1]</span></span>
<span class="line"><span>Annoy 安装成功！</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-4-常见安装问题" tabindex="-1">2.4 常见安装问题 <a class="header-anchor" href="#_2-4-常见安装问题" aria-label="Permalink to &quot;2.4 常见安装问题&quot;">​</a></h3><p><strong>问题 1：Windows 上编译失败</strong></p><p>Annoy 需要 C++ 编译器。Windows 用户如果遇到编译错误，有以下解决方案：</p><p><strong>方案 A：使用预编译的 wheel 文件（推荐）</strong></p><p>从 GitHub 下载预编译的 wheel 文件：<a href="https://github.com/Sprocketer/annoy-wheels" target="_blank" rel="noreferrer">https://github.com/Sprocketer/annoy-wheels</a></p><p>根据你的 Python 版本下载对应的 <code>.whl</code> 文件，然后本地安装：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 示例：Python 3.11 + Windows 64位</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy-1.17.3-cp311-cp311-win_amd64.whl</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>方案 B：使用 conda 安装</strong></p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">conda</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> conda-forge</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> python-annoy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>方案 C：安装 C++ 编译环境</strong></p><p>安装 <a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/" target="_blank" rel="noreferrer">Visual Studio Build Tools</a>，然后重新 <code>pip install annoy</code>。</p><p><strong>问题 2：Apple Silicon (M1/M2) 兼容性</strong></p><p>较新版本的 Annoy 已支持 Apple Silicon，直接 pip 安装即可。如遇问题，尝试：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annoy</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><hr><h2 id="_3-快速上手-5-分钟入门" tabindex="-1">3. 快速上手：5 分钟入门 <a class="header-anchor" href="#_3-快速上手-5-分钟入门" aria-label="Permalink to &quot;3. 快速上手：5 分钟入门&quot;">​</a></h2><p>让我们通过一个完整的例子，快速了解 Annoy 的核心用法。</p><h3 id="_3-1-完整示例" tabindex="-1">3.1 完整示例 <a class="header-anchor" href="#_3-1-完整示例" aria-label="Permalink to &quot;3.1 完整示例&quot;">​</a></h3><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> annoy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AnnoyIndex</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> numpy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第一步：创建索引 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 参数说明：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - 128: 向量维度</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - &#39;angular&#39;: 距离度量（余弦距离）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AnnoyIndex(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;angular&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第二步：添加向量 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生成一些随机向量模拟数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">np.random.seed(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n_vectors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vectors </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np.random.randn(n_vectors, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).astype(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;float32&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 添加向量到索引</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># add_item(i, vector): i 是向量的唯一标识（整数）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i, vec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> enumerate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vectors):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    index.add_item(i, vec)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;已添加 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index.get_n_items()</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 个向量&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第三步：构建索引 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># build(n_trees): n_trees 是树的数量，越多精度越高但占用更多内存</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n_trees </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index.build(n_trees)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;索引构建完成，共 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index.get_n_trees()</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 棵树&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第四步：保存索引 ============</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index.save(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;demo_index.ann&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;索引已保存到 demo_index.ann&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第五步：加载索引 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建新的索引对象并加载</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AnnoyIndex(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;angular&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">index2.load(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;demo_index.ann&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;索引加载成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第六步：搜索 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建一个查询向量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> np.random.randn(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).astype(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;float32&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># get_nns_by_vector(vector, n, search_k=-1, include_distances=False)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - vector: 查询向量</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - n: 返回最近的 n 个结果</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - search_k: 搜索时检查的节点数，-1 表示使用默认值 n_trees * n</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># - include_distances: 是否返回距离</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index2.get_nns_by_vector(query, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">include_distances</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">查询结果（前5个最近邻）:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;索引: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">results[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;距离: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">results[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ============ 第七步：根据已有向量搜索 ============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># get_nns_by_item(i, n): 找到与第 i 个向量最相似的 n 个向量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">similar_to_0 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index2.get_nns_by_item(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">include_distances</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">与向量 0 最相似的 5 个向量:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;索引: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">similar_to_0[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;距离: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">similar_to_0[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>运行代码后，你将看到类似输出：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>已添加 10000 个向量</span></span>
<span class="line"><span>索引构建完成，共 10 棵树</span></span>
<span class="line"><span>索引已保存到 demo_index.ann</span></span>
<span class="line"><span>索引加载成功</span></span>
<span class="line"><span></span></span>
<span class="line"><span>查询结果（前5个最近邻）:</span></span>
<span class="line"><span>索引: [3122, 5514, 1890, 1286, 2316]</span></span>
<span class="line"><span>距离: [1.254392, 1.2594, 1.261284, 1.277733, 1.285302]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>与向量 0 最相似的 5 个向量:</span></span>
<span class="line"><span>索引: [0, 1144, 24, 6459, 4111]</span></span>
<span class="line"><span>距离: [0.000135, 1.266683, 1.277138, 1.280767, 1.28747]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">注意</p><p>由于随机数生成，你的具体数值可能不同，但格式是一致的。第一个结果的距离为 0 是因为查询的是向量本身。</p></div><h3 id="_3-2-代码要点总结" tabindex="-1">3.2 代码要点总结 <a class="header-anchor" href="#_3-2-代码要点总结" aria-label="Permalink to &quot;3.2 代码要点总结&quot;">​</a></h3><table tabindex="0"><thead><tr><th>步骤</th><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>创建索引</td><td><code>AnnoyIndex(dim, metric)</code></td><td>指定维度和距离度量</td></tr><tr><td>添加向量</td><td><code>add_item(i, vector)</code></td><td>i 必须是非负整数</td></tr><tr><td>构建索引</td><td><code>build(n_trees)</code></td><td>构建后不能再添加向量</td></tr><tr><td>保存索引</td><td><code>save(filename)</code></td><td>保存到文件</td></tr><tr><td>加载索引</td><td><code>load(filename)</code></td><td>从文件加载</td></tr><tr><td>搜索（向量）</td><td><code>get_nns_by_vector(v, n)</code></td><td>根据向量搜索</td></tr><tr><td>搜索（索引）</td><td><code>get_nns_by_item(i, n)</code></td><td>根据已有向量的索引搜索</td></tr></tbody></table><hr><h2 id="_4-与-base-章节的衔接" tabindex="-1">4. 与 base 章节的衔接 <a class="header-anchor" href="#_4-与-base-章节的衔接" aria-label="Permalink to &quot;4. 与 base 章节的衔接&quot;">​</a></h2><p>如果你已经学习了 base 章节的内容，你可能注意到：</p><ul><li><strong>base/chapter5/Annoy算法.md</strong> 中我们<strong>手动实现</strong>了一个 <code>SimpleAnnoy</code> 类，深入理解了随机投影树的原理</li><li>本章使用的是 <strong>Spotify 官方的 annoy 库</strong>，它是用 C++ 实现的，性能更高</li></ul><p>两者的关系：</p><table tabindex="0"><thead><tr><th>对比项</th><th>base 中的 SimpleAnnoy</th><th>本章的 annoy 库</th></tr></thead><tbody><tr><td>目的</td><td>理解算法原理</td><td>生产环境使用</td></tr><tr><td>实现语言</td><td>Python</td><td>C++（Python 绑定）</td></tr><tr><td>性能</td><td>较慢（教学用）</td><td>高性能</td></tr><tr><td>功能</td><td>基础功能</td><td>完整功能（mmap、多线程等）</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">推荐学习路径</p><ol><li>先阅读 <a href="/easy-vecdb/base/chapter5/Annoy算法.html">base/chapter5/Annoy算法</a> 理解随机投影树原理</li><li>再学习本章，掌握官方库的实际使用</li></ol></div></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/datawhalechina/easy-vecdb/edit/main/docs/Annoy/chapter1/Annoy入门与环境搭建.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 在 GitHub 上编辑此页<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>最后更新于: <time datetime="2026-01-27T03:48:11.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/easy-vecdb/Annoy/chapter2/Annoy%E6%A0%B8%E5%BF%83API%E8%AF%A6%E8%A7%A3.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>Annoy核心API详解</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>基于 Apache-2.0 许可发布</p><p class="copyright" data-v-e315a0ad><a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2026002630号-1</a> | <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010602202215" rel="noreferrer" target="_blank">京公网安备11010602202215号</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"annoy_chapter1_annoy入门与环境搭建.md\":\"C86TB_kz\",\"annoy_chapter2_annoy核心api详解.md\":\"BdxKLN3m\",\"annoy_chapter3_annoy进阶技巧与最佳实践.md\":\"EADTfvty\",\"base_chapter1_学习路径推荐.md\":\"Daij0OP6\",\"base_chapter1_项目介绍.md\":\"igi-N8LW\",\"base_chapter2_为什么需要向量数据库.md\":\"DOOY35CH\",\"base_chapter3_向量嵌入算法基础.md\":\"BAVj6Rxq\",\"base_chapter4_向量搜索算法基础.md\":\"C2zPg0SL\",\"base_chapter5_annoy算法.md\":\"B7hd0TSm\",\"base_chapter5_ann搜索算法.md\":\"BVGDWXXe\",\"base_chapter5_hnsw算法.md\":\"BFcShGAu\",\"base_chapter5_ivf算法.md\":\"Z4APPMk4\",\"base_chapter5_lsh算法.md\":\"CEiBi1_C\",\"base_chapter5_pq算法.md\":\"D6LTdySi\",\"base_chapter6_实现你自己的向量数据库.md\":\"Bby1XfT-\",\"faiss_chapter1_faiss入门与环境搭建.md\":\"B1102qHm\",\"faiss_chapter2_faiss数据结构与索引.md\":\"wNHEvArG\",\"faiss_chapter3_faiss核心功能进阶.md\":\"CWHKzKDF\",\"faiss_chapter4_faiss性能调优与评估.md\":\"BESwZH_r\",\"faiss_chapter5_faiss工程化落地实战.md\":\"C-14T22S\",\"index.md\":\"DNVwDjEp\",\"milvus_chapter1_milvus向量数据库入门.md\":\"C6XYXgjy\",\"milvus_chapter2_milvus核心概念.md\":\"hKoqcOt6\",\"milvus_chapter3_pymilvus核心api实战.md\":\"8zR9WrqF\",\"milvus_chapter4_milvus的ai应用开发.md\":\"DgW_YVAK\",\"milvus_chapter5_milvus的ai应用开发.md\":\"OR-95EMj\",\"milvus_chapter6_milvus lite部署与应用.md\":\"JFtQ48mt\",\"milvus_chapter6_milvus reranker重排.md\":\"CFE_KuVK\",\"milvus_chapter6_milvus 存储优化.md\":\"is0KMx8t\",\"milvus_chapter6_milvus底层架构详解.md\":\"C9WAQVcm\",\"milvus_chapter6_mineru部署教程.md\":\"D5H6QSLi\",\"more_chapter1_gpu加速检索-基于fusionanns.md\":\"CfIev-Kt\",\"more_chapter2_meta-chunking：一种新的文本切分策略.md\":\"BS871zQ0\",\"more_chapter3_limit基于嵌入检索的理论极限.md\":\"8lcgKgwB\",\"more_chapter3_meta_limit_code_startup.md\":\"Cn416tJt\",\"more_chapter4_rabitq：用于近似最近邻搜索的带理论误差界的高维向量量化.md\":\"BTFBP4ot\",\"more_chapter5_向量.md\":\"2Fx0juom\",\"more_chapter6_k-mean算法详解.md\":\"BTJ9_1pl\",\"more_chapter6_聚类算法介绍.md\":\"BrVmwXc5\",\"more_milvus 数据切分总结.md\":\"Bgy33nqW\",\"projects_index.md\":\"0ENSoYyC\",\"projects_project1_readme.md\":\"DevbXIn7\",\"projects_project2_readme.md\":\"_QUWrFZ8\",\"projects_project3_readme.md\":\"CAmd7TaH\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"EasyVecDB 教程\",\"description\":\"向量数据库学习与实战指南\",\"base\":\"/easy-vecdb/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"returnToTopLabel\":\"返回顶部\",\"logo\":\"/favicon.ico\",\"outline\":{\"level\":[1,4]},\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"向量基础\",\"link\":\"/base/chapter1/项目介绍\"},{\"text\":\"Annoy 教程\",\"link\":\"/Annoy/chapter1/Annoy入门与环境搭建\"},{\"text\":\"Faiss 教程\",\"link\":\"/Faiss/chapter1/FAISS入门与环境搭建\"},{\"text\":\"Milvus 教程\",\"link\":\"/Milvus/chapter1/Milvus向量数据库入门\"},{\"text\":\"补充内容\",\"link\":\"/more/chapter5/向量\"},{\"text\":\"实战项目\",\"link\":\"/projects/\"}],\"sidebar\":{\"/base/\":[{\"text\":\"Chapter 1 · 项目介绍\",\"items\":[{\"text\":\"项目介绍\",\"link\":\"/base/chapter1/项目介绍\"},{\"text\":\"学习路径推荐\",\"link\":\"/base/chapter1/学习路径推荐\"}]},{\"text\":\"Chapter 2 · 向量数据库概念\",\"items\":[{\"text\":\"为什么需要向量数据库\",\"link\":\"/base/chapter2/为什么需要向量数据库\"}]},{\"text\":\"Chapter 3 · 向量嵌入算法基础\",\"items\":[{\"text\":\"向量嵌入算法基础\",\"link\":\"/base/chapter3/向量嵌入算法基础\"}]},{\"text\":\"Chapter 4 · 向量搜索算法基础\",\"items\":[{\"text\":\"向量搜索算法基础\",\"link\":\"/base/chapter4/向量搜索算法基础\"}]},{\"text\":\"Chapter 5 · 向量ANN搜索算法\",\"items\":[{\"text\":\"ANN搜索算法\",\"link\":\"/base/chapter5/ANN搜索算法\"},{\"text\":\"Annoy算法\",\"link\":\"/base/chapter5/Annoy算法\"},{\"text\":\"IVF算法\",\"link\":\"/base/chapter5/IVF算法\"},{\"text\":\"HNSW算法\",\"link\":\"/base/chapter5/HNSW算法\"},{\"text\":\"PQ算法\",\"link\":\"/base/chapter5/PQ算法\"},{\"text\":\"LSH算法\",\"link\":\"/base/chapter5/LSH算法\"}]},{\"text\":\"Chapter 6 · 实现你自己的向量数据库\",\"items\":[{\"text\":\"实现你自己的向量数据库\",\"link\":\"/base/chapter6/实现你自己的向量数据库\"}]}],\"/Annoy/\":[{\"text\":\"Chapter 1 · Annoy入门与环境搭建\",\"items\":[{\"text\":\"Annoy入门与环境搭建\",\"link\":\"/Annoy/chapter1/Annoy入门与环境搭建\"}]},{\"text\":\"Chapter 2 · Annoy核心API详解\",\"items\":[{\"text\":\"Annoy核心API详解\",\"link\":\"/Annoy/chapter2/Annoy核心API详解\"}]},{\"text\":\"Chapter 3 · Annoy进阶技巧与最佳实践\",\"items\":[{\"text\":\"Annoy进阶技巧与最佳实践\",\"link\":\"/Annoy/chapter3/Annoy进阶技巧与最佳实践\"}]}],\"/Faiss/\":[{\"text\":\"Chapter 1 · FAISS入门与环境搭建\",\"items\":[{\"text\":\"FAISS 入门与环境搭建\",\"link\":\"/Faiss/chapter1/FAISS入门与环境搭建\"}]},{\"text\":\"Chapter 2 · FAISS数据结构与索引类型\",\"items\":[{\"text\":\"FAISS数据结构与索引类型\",\"link\":\"/Faiss/chapter2/FAISS数据结构与索引\"}]},{\"text\":\"Chapter 3 · FAISS核心功能进阶\",\"items\":[{\"text\":\"FAISS核心功能进阶\",\"link\":\"/Faiss/chapter3/FAISS核心功能进阶\"}]},{\"text\":\"Chapter 4 · FAISS性能调优与评估\",\"items\":[{\"text\":\"FAISS性能调优与评估\",\"link\":\"/Faiss/chapter4/FAISS性能调优与评估\"}]},{\"text\":\"Chapter 5 · FAISS工程化落地实战\",\"items\":[{\"text\":\"FAISS工程化落地实战\",\"link\":\"/Faiss/chapter5/FAISS工程化落地实战\"}]}],\"/Milvus/\":[{\"text\":\"Chapter 1 · Milvus向量数据库入门\",\"items\":[{\"text\":\"Milvus向量数据库入门\",\"link\":\"/Milvus/chapter1/Milvus向量数据库入门\"}]},{\"text\":\"Chapter 2 · Milvus核心概念\",\"items\":[{\"text\":\"Milvus核心概念\",\"link\":\"/Milvus/chapter2/Milvus核心概念\"}]},{\"text\":\"Chapter 3 · Milvus基础操作\",\"items\":[{\"text\":\"Milvus基础操作\",\"link\":\"/Milvus/chapter3/PyMilvus核心API实战\"}]},{\"text\":\"Chapter 4 · Milvus的AI应用开发\",\"items\":[{\"text\":\"综合实战:基于BM25的混合搜索向量数据库开发实战\",\"link\":\"/Milvus/chapter4/Milvus的AI应用开发\"}]},{\"text\":\"Chapter 5 · Milvus的AI应用开发\",\"items\":[{\"text\":\"综合实战:图像检索应用实战\",\"link\":\"/Milvus/chapter5/Milvus的AI应用开发\"}]},{\"text\":\"Chapter 6 · Milvus选学部分\",\"items\":[{\"text\":\"Milvus底层架构详解\",\"link\":\"/Milvus/chapter6/Milvus底层架构详解\"},{\"text\":\"Milvus Reranker\",\"link\":\"/Milvus/chapter6/Milvus Reranker重排\"},{\"text\":\"Milvus Lite部署教程\",\"link\":\"/Milvus/chapter6/Milvus Lite部署与应用\"},{\"text\":\"MinerU 部署教程\",\"link\":\"/Milvus/chapter5/MinerU部署教程\"}]}],\"/more/\":[{\"text\":\"Chapter 1 · FusionANNS\",\"items\":[{\"text\":\"FusionANNS架构设计\",\"link\":\"/more/chapter1/GPU加速检索-基于FusionANNS\"}]},{\"text\":\"Chapter 2 · Meta-Chunking\",\"items\":[{\"text\":\"全新的文本切分策略\",\"link\":\"/more/chapter2/Meta-Chunking：一种新的文本切分策略\"}]},{\"text\":\"Chapter 3 · Limit\",\"items\":[{\"text\":\"基于嵌入检索的理论极限\",\"link\":\"/more/chapter3/Limit基于嵌入检索的理论极限\"},{\"text\":\"实践操作\",\"link\":\"/more/chapter3/Meta_limit/code/startup\"}]},{\"text\":\"Chapter 4 · RabitQ\",\"items\":[{\"text\":\"RabitQ索引\",\"link\":\"/more/chapter4/RabitQ：用于近似最近邻搜索的带理论误差界的高维向量量化\"}]},{\"text\":\"Chapter 5 · 稀疏、稠密向量\",\"items\":[{\"text\":\"向量基础知识\",\"link\":\"/more/chapter5/向量\"}]},{\"text\":\"Chapter 6 · 聚类算法\",\"items\":[{\"text\":\"两种聚类算法\",\"link\":\"/more/chapter6/聚类算法介绍\"},{\"text\":\"K-means聚类详解\",\"link\":\"/more/chapter6/K-mean算法详解\"}]}],\"/projects/\":[{\"text\":\"实战项目1\",\"items\":[{\"text\":\"基于FAISS框架RAG实战项目\",\"link\":\"/projects/project1/README\"}]},{\"text\":\"实战项目2\",\"items\":[{\"text\":\"基于Milvus框架的Agent项目\",\"link\":\"/projects/project2/README\"}]},{\"text\":\"实战项目3\",\"items\":[{\"text\":\"基于Milvus和ArangoDB的RAG系统\",\"link\":\"/projects/project3/README\"}]},{\"text\":\"实战概览\",\"items\":[{\"text\":\"项目概览\",\"link\":\"/projects/\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/datawhalechina/easy-vecdb\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/datawhalechina/easy-vecdb/edit/main/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"lastUpdated\":{\"text\":\"最后更新于\",\"formatOptions\":{\"dateStyle\":\"short\",\"timeStyle\":\"medium\"}},\"footer\":{\"message\":\"基于 Apache-2.0 许可发布\",\"copyright\":\"<a href=\\\"https://beian.miit.gov.cn/\\\" target=\\\"_blank\\\">京ICP备2026002630号-1</a> | <a href=\\\"https://beian.mps.gov.cn/#/query/webSearch?code=11010602202215\\\" rel=\\\"noreferrer\\\" target=\\\"_blank\\\">京公网安备11010602202215号</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>