# IVFç®—æ³•

## ğŸ” ç®—æ³•åŸç†åˆ†æ­¥è¯¦è§£â€‹

ç¬¬ä¸€é˜¶æ®µï¼šç´¢å¼•æ„å»ºï¼ˆå»ºåº“ä¸åˆ†ç±»ï¼‰â€‹â€‹
æ„å»ºç´¢å¼•çš„ç›®çš„æ˜¯ä¸ºæ•°æ®å»ºç«‹ä¸€ä¸ªé«˜æ•ˆçš„ç»“æ„åŒ–ç›®å½•ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸æ˜¯ç¦»çº¿å®Œæˆçš„ã€‚
**â€‹1.â€‹èšç±»è®­ç»ƒï¼ˆClusteringï¼‰â€‹â€‹**
ä½¿ç”¨èšç±»ç®—æ³•ï¼ˆæœ€å¸¸ç”¨çš„æ˜¯ â€‹â€‹K-Meansâ€‹â€‹ï¼‰å°†æ‰€æœ‰å‘é‡åˆ’åˆ†æˆ nlistä¸ªç°‡ï¼ˆclustersï¼‰ã€‚nlistæ˜¯ä¸€ä¸ªå…³é”®å‚æ•°ï¼Œå®ƒå†³å®šäº†ç©ºé—´åˆ’åˆ†çš„ç²’åº¦ã€‚æ¯ä¸ªç°‡éƒ½æœ‰ä¸€ä¸ªä¸­å¿ƒç‚¹ï¼Œç§°ä¸ºâ€‹â€‹è´¨å¿ƒï¼ˆcentroidï¼‰â€‹â€‹ã€‚æ‰€æœ‰è¿™äº›è´¨å¿ƒæ„æˆäº†ä¸€ä¸ªâ€œè´¨å¿ƒè¡¨â€ï¼Œç›¸å½“äºå›¾ä¹¦é¦†çš„â€‹â€‹æ€»åˆ†ç±»ç›®å½•â€‹â€‹ã€‚
**â€‹2.â€‹å‘é‡åˆ†é…ï¼ˆAssignmentï¼‰â€‹â€‹**
éå†æ•°æ®é›†ä¸­çš„æ¯ä¸€ä¸ªå‘é‡ï¼Œè®¡ç®—å®ƒä¸æ‰€æœ‰è´¨å¿ƒçš„è·ç¦»ï¼ˆå¦‚æ¬§æ°è·ç¦»ï¼‰ã€‚å°†æ¯ä¸ªå‘é‡åˆ†é…åˆ°â€‹â€‹è·ç¦»å®ƒæœ€è¿‘çš„é‚£ä¸ªè´¨å¿ƒâ€‹â€‹æ‰€å¯¹åº”çš„ç°‡ä¸­ã€‚
**3.â€‹â€‹å½¢æˆå€’æ’åˆ—è¡¨ï¼ˆInverted Listsï¼‰â€‹â€‹**
ä¸ºæ¯ä¸€ä¸ªç°‡å»ºç«‹ä¸€ä¸ªâ€‹â€‹å€’æ’åˆ—è¡¨â€‹â€‹ï¼ˆæˆ–ç§°â€œå¼ è´´åˆ—è¡¨â€ï¼‰ã€‚è¿™ä¸ªåˆ—è¡¨å°±åƒå›¾ä¹¦é¦†æ¯ä¸ªåˆ†ç±»ä¹¦æ¶ä¸Šçš„å›¾ä¹¦æ¸…å•ï¼Œå®ƒè®°å½•äº†æ‰€æœ‰å±äºè¿™ä¸ªç°‡çš„â€‹â€‹å‘é‡çš„IDä»¥åŠå‘é‡æœ¬èº«â€‹â€‹ï¼ˆæˆ–å®ƒçš„å‹ç¼©è¡¨ç¤ºï¼‰ã€‚è‡³æ­¤ï¼Œç´¢å¼•æ„å»ºå®Œæˆã€‚

ç¬¬äºŒé˜¶æ®µï¼šæŸ¥è¯¢å¤„ç†ï¼ˆå¿«é€Ÿæ£€ç´¢ï¼‰â€‹â€‹
å½“ä¸€ä¸ªæ–°çš„æŸ¥è¯¢å‘é‡åˆ°æ¥æ—¶ï¼ŒIVFåˆ©ç”¨å·²æ„å»ºå¥½çš„ç´¢å¼•è¿›è¡Œå¿«é€Ÿæ£€ç´¢ã€‚
**â€‹1.â€‹å®šä½æœ€è¿‘ç°‡ï¼ˆCoarse Quantizationï¼‰â€‹â€‹**
è®¡ç®—æŸ¥è¯¢å‘é‡ä¸â€‹â€‹è´¨å¿ƒè¡¨â€‹â€‹ä¸­æ‰€æœ‰ nlistä¸ªè´¨å¿ƒçš„è·ç¦»ã€‚

**2.â€‹é€‰æ‹©å€™é€‰ç°‡ï¼ˆnprobe å‚æ•°æ§åˆ¶ï¼‰â€‹â€‹**
æ ¹æ®ä¸Šä¸€æ­¥çš„è·ç¦»ç»“æœï¼Œé€‰æ‹©è·ç¦»æœ€è¿‘çš„ nprobeä¸ªç°‡ä½œä¸ºå€™é€‰ç°‡ã€‚â€‹â€‹nprobeæ˜¯IVFç®—æ³•ä¸­æœ€å…³é”®çš„è°ƒä¼˜å‚æ•°ä¹‹ä¸€â€‹â€‹ï¼š
nprobeè¶Šå°ï¼Œæœç´¢èŒƒå›´è¶Šå°ï¼Œâ€‹â€‹é€Ÿåº¦è¶Šå¿«ï¼Œä½†å¯èƒ½æ¼æ‰ä¸€äº›çœŸæ­£è¿‘é‚»ï¼ˆå¬å›ç‡é™ä½ï¼‰â€‹â€‹ã€‚
nprobeè¶Šå¤§ï¼Œæœç´¢èŒƒå›´è¶Šå¤§ï¼Œâ€‹â€‹å¬å›ç‡è¶Šé«˜ï¼Œä½†è®¡ç®—é‡å¢å¤§ï¼Œé€Ÿåº¦å˜æ…¢â€‹â€‹ã€‚

**â€‹3.â€‹ç°‡å†…ç²¾ç»†æ¯”è¾ƒï¼ˆFine Comparisonï¼‰â€‹â€‹**
åœ¨é€‰å®šçš„ nprobeä¸ªå€™é€‰ç°‡çš„å€’æ’åˆ—è¡¨ä¸­ï¼Œè¿›è¡Œç²¾ç»†çš„è·ç¦»è®¡ç®—ã€‚
å…·ä½“æ–¹å¼å–å†³äºIVFçš„å˜ä½“ï¼š
  - IVF-Flatï¼šç›´æ¥ä½¿ç”¨åŸå§‹çš„ã€æœªå‹ç¼©çš„å‘é‡ä¸æŸ¥è¯¢å‘é‡è¿›è¡Œç²¾ç¡®è·ç¦»è®¡ç®—ã€‚è¿™ç§æ–¹å¼ç²¾åº¦æœ€é«˜ï¼Œä½†å†…å­˜å ç”¨ä¹Ÿæœ€å¤§ã€‚ 
  - IVF-PQï¼šä¸ºäº†è¿›ä¸€æ­¥èŠ‚çœå†…å­˜å’ŒåŠ é€Ÿè®¡ç®—ï¼Œä¼šå¯¹ç°‡å†…å‘é‡ä½¿ç”¨ä¹˜ç§¯é‡åŒ–ï¼ˆProduct Quantizationï¼‰ è¿›è¡Œå‹ç¼©ã€‚æœç´¢æ—¶ä½¿ç”¨è¿‘ä¼¼è·ç¦»è®¡ç®—ï¼Œè¿™æ˜¯ä¸€ç§ç”¨å°‘é‡ç²¾åº¦æ¢å–å·¨å¤§å­˜å‚¨å’Œè®¡ç®—æ•ˆç‡æå‡çš„ç­–ç•¥ã€‚

**â€‹4.â€‹ç»“æœåˆå¹¶ä¸è¿”å›â€‹â€‹**
å°†æ‰€æœ‰å€™é€‰ç°‡ä¸­çš„å‘é‡æ ¹æ®ä¸æŸ¥è¯¢å‘é‡çš„è·ç¦»è¿›è¡Œæ’åºï¼Œæœ€ç»ˆè¿”å› Top-K ä¸ªæœ€ç›¸ä¼¼çš„å‘é‡ä½œä¸ºç»“æœã€‚

VFçš„æ€§èƒ½å’Œæ•ˆæœå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä¸¤ä¸ªæ ¸å¿ƒå‚æ•°çš„è®¾ç½®ï¼Œå®ƒä»¬å°±åƒè¿™ä¸ªç³»ç»Ÿçš„â€œè°ƒé€Ÿå™¨â€ï¼š

- nlistï¼ˆèšç±»æ•°ï¼‰ï¼šå†³å®šäº†ç©ºé—´çš„åˆ’åˆ†ç²’åº¦ã€‚nlist è¶Šå¤§ï¼Œæœç´¢èŒƒå›´è¶Šå¤§ï¼Œå¬å›ç‡è¶Šé«˜ï¼›ä½†åŒæ—¶ä¹Ÿå¢åŠ äº†è®¡ç®—é‡ã€‚
- nprobeï¼ˆå€™é€‰ç°‡æ•°ï¼‰ï¼šæ§åˆ¶äº†æœç´¢çš„èŒƒå›´ã€‚nprobe è¶Šå°ï¼Œæœç´¢è¶Šå¿«ï¼Œä½†å¯èƒ½ä¼šæ¼æ‰ä¸€äº›è¿‘é‚»ï¼›nprobe è¶Šå¤§ï¼Œæœç´¢èŒƒå›´è¶Šå¤§ï¼Œå¬å›ç‡è¶Šé«˜ï¼Œä½†è®¡ç®—é‡å¢å¤§ã€‚

## IVFç®—æ³•å®ç°

ğŸ§  IVFç®—æ³•Pythonå®ç°

**é¦–å…ˆï¼Œæˆ‘ä»¬å¯¼å…¥å¿…è¦çš„åº“ï¼š**
```python 
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity, euclidean_distances
import matplotlib.pyplot as plt
import time
from collections import defaultdict
plt.rcParams['font.sans-serif'] = ['Microsoft YaHei']
plt.rcParams['axes.unicode_minus'] = False

# è®¾ç½®éšæœºç§å­ä»¥ä¿è¯ç»“æœå¯é‡ç°
np.random.seed(42)
```

**ğŸ“Š ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®**
æˆ‘ä»¬åˆ›å»ºä¸€äº›ç®€å•çš„äºŒç»´æ•°æ®ï¼Œæ–¹ä¾¿å¯è§†åŒ–ç†è§£ï¼š
```python
def generate_sample_data(n_samples=1000, dim=2):
    """ç”Ÿæˆç¤ºä¾‹æ•°æ®ï¼šä¸‰ä¸ªæ˜æ˜¾åˆ†ç¦»çš„é«˜æ–¯åˆ†å¸ƒç°‡"""
    # ç¬¬ä¸€ä¸ªç°‡
    cluster1 = np.random.normal(loc=[2, 2], scale=0.5, size=(n_samples//3, dim))
    # ç¬¬äºŒä¸ªç°‡  
    cluster2 = np.random.normal(loc=[8, 3], scale=0.6, size=(n_samples//3, dim))
    # ç¬¬ä¸‰ä¸ªç°‡
    cluster3 = np.random.normal(loc=[5, 8], scale=0.4, size=(n_samples - 2*(n_samples//3), dim))
    
    data = np.vstack([cluster1, cluster2, cluster3])
    return data

# ç”Ÿæˆæ•°æ®
data = generate_sample_data()
print(f"æ•°æ®å½¢çŠ¶: {data.shape}")
```
è¾“å‡ºç»“æœï¼š
```
æ•°æ®å½¢çŠ¶: (1000, 2)
```

**âš™ï¸ ç¬¬äºŒæ­¥ï¼šæ‰‹åŠ¨å®ç°K-meansèšç±»**
è¿™æ˜¯IVFç®—æ³•çš„æ ¸å¿ƒé¢„å¤„ç†æ­¥éª¤ï¼š

```python
class SimpleKMeans:
    """ç®€åŒ–çš„K-meanså®ç°ç”¨äºIVFèšç±»"""
    
    def __init__(self, n_clusters=3, max_iters=100):
        self.n_clusters = n_clusters
        self.max_iters = max_iters
        self.centroids = None
        self.labels_ = None
    
    def fit(self, X):
        n_samples, n_features = X.shape
        
        # 1. éšæœºåˆå§‹åŒ–è´¨å¿ƒ
        random_indices = np.random.choice(n_samples, self.n_clusters, replace=False)
        self.centroids = X[random_indices]
        
        for iteration in range(self.max_iters):
            # 2. åˆ†é…æ¯ä¸ªç‚¹åˆ°æœ€è¿‘çš„è´¨å¿ƒ
            distances = euclidean_distances(X, self.centroids)
            labels = np.argmin(distances, axis=1)
            
            # 3. æ›´æ–°è´¨å¿ƒä½ç½®
            new_centroids = np.array([X[labels == i].mean(axis=0) for i in range(self.n_clusters)])
            
            # æ£€æŸ¥æ”¶æ•›
            if np.allclose(self.centroids, new_centroids):
                break
                
            self.centroids = new_centroids
        
        self.labels_ = labels
        return self
```

**ğŸ“ ç¬¬ä¸‰æ­¥ï¼šå®ç°å€’æ’æ–‡ä»¶ç´¢å¼•(IVF)**
ç°åœ¨å®ç°å®Œæ•´çš„IVFç´¢å¼•ç»“æ„ï¼š

```python
class SimpleIVF:
    """ç®€åŒ–çš„IVFå®ç°"""
    
    def __init__(self, n_clusters=3, n_probe=2):
        self.n_clusters = n_clusters
        self.n_probe = n_probe  # æœç´¢æ—¶æ¢æµ‹çš„ç°‡æ•°é‡
        self.kmeans = None
        self.inverted_lists = None  # å€’æ’åˆ—è¡¨
        self.centroids = None
        self.is_trained = False
    
    def train(self, data):
        """è®­ç»ƒIVFç´¢å¼•ï¼šå¯¹æ•°æ®è¿›è¡Œèšç±»"""
        print("å¼€å§‹è®­ç»ƒIVFç´¢å¼•...")
        self.kmeans = SimpleKMeans(n_clusters=self.n_clusters)
        self.kmeans.fit(data)
        self.centroids = self.kmeans.centroids
        self.is_trained = True
        print(f"è®­ç»ƒå®Œæˆï¼Œå¾—åˆ°{self.n_clusters}ä¸ªç°‡")
    
    def build_index(self, data):
        """æ„å»ºå€’æ’ç´¢å¼•"""
        if not self.is_trained:
            self.train(data)
        
        # åˆå§‹åŒ–å€’æ’åˆ—è¡¨
        self.inverted_lists = defaultdict(list)
        
        # å°†æ¯ä¸ªå‘é‡åˆ†é…åˆ°æœ€è¿‘çš„ç°‡
        distances = euclidean_distances(data, self.centroids)
        labels = np.argmin(distances, axis=1)
        
        # æ„å»ºå€’æ’åˆ—è¡¨ï¼šç°‡ID -> è¯¥ç°‡ä¸­æ‰€æœ‰å‘é‡çš„ç´¢å¼•
        for idx, label in enumerate(labels):
            self.inverted_lists[label].append(idx)
        
        print("å€’æ’ç´¢å¼•æ„å»ºå®Œæˆ:")
        for cluster_id, items in self.inverted_lists.items():
            print(f"  ç°‡{cluster_id}: {len(items)}ä¸ªå‘é‡")
    
    def search(self, query, k=5, data=None):
        """IVFæœç´¢ï¼šå…ˆæ‰¾æœ€è¿‘çš„ç°‡ï¼Œç„¶ååœ¨ç°‡å†…æœç´¢"""
        if data is None:
            data = self.data
            
        # 1. ç²—ç•¥æœç´¢ï¼šæ‰¾åˆ°æœ€è¿‘çš„n_probeä¸ªç°‡
        distances_to_centroids = euclidean_distances([query], self.centroids)[0]
        nearest_cluster_indices = np.argsort(distances_to_centroids)[:self.n_probe]
        
        # 2. ç²¾ç»†æœç´¢ï¼šåœ¨é€‰ä¸­çš„ç°‡å†…è¿›è¡Œæš´åŠ›æœç´¢
        candidate_indices = []
        for cluster_idx in nearest_cluster_indices:
            candidate_indices.extend(self.inverted_lists[cluster_idx])
        
        if not candidate_indices:
            return [], []
        
        # åœ¨å€™é€‰å‘é‡ä¸­è®¡ç®—è·ç¦»
        candidate_vectors = data[candidate_indices]
        distances = euclidean_distances([query], candidate_vectors)[0]
        
        # è·å–æœ€è¿‘çš„kä¸ªç»“æœ
        if k > len(distances):
            k = len(distances)
            
        nearest_indices_within_candidates = np.argsort(distances)[:k]
        
        # æ˜ å°„å›åŸå§‹ç´¢å¼•
        final_indices = [candidate_indices[i] for i in nearest_indices_within_candidates]
        final_distances = distances[nearest_indices_within_candidates]
        
        return final_indices, final_distances
    
    def brute_force_search(self, query, k=5, data=None):
        """æš´åŠ›æœç´¢ä½œä¸ºå¯¹æ¯”åŸºå‡†"""
        if data is None:
            data = self.data
            
        distances = euclidean_distances([query], data)[0]
        nearest_indices = np.argsort(distances)[:k]
        return nearest_indices, distances[nearest_indices]
```

**ğŸ” ç¬¬å››æ­¥ï¼šç®—æ³•å®ç°**
è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥å±•ç¤ºIVFçš„å·¥ä½œåŸç†ï¼š

```python
def demonstrate_ivf():
    """å®Œæ•´æ¼”ç¤ºIVFç®—æ³•"""
    print("=" * 60)
    print("IVFç®—æ³•æ¼”ç¤º")
    print("=" * 60)
    
    # 1. ç”Ÿæˆæ•°æ®
    data = generate_sample_data(300, 2)
    print(f"ç”Ÿæˆ{len(data)}ä¸ªäºŒç»´æ•°æ®ç‚¹")
    
    # 2. åˆ›å»ºå¹¶è®­ç»ƒIVFç´¢å¼•
    ivf = SimpleIVF(n_clusters=3, n_probe=2)
    ivf.data = data  # ä¿å­˜æ•°æ®å¼•ç”¨
    ivf.build_index(data)
    
    # 3. é€‰æ‹©ä¸€ä¸ªæŸ¥è¯¢ç‚¹
    query_point = np.array([5.0, 5.0])
    print(f"\næŸ¥è¯¢ç‚¹: {query_point}")
    
    # 4. ä½¿ç”¨IVFæœç´¢
    start_time = time.time()
    ivf_indices, ivf_distances = ivf.search(query_point, k=5, data=data)
    ivf_time = time.time() - start_time
    
    # 5. ä½¿ç”¨æš´åŠ›æœç´¢ä½œä¸ºå¯¹æ¯”
    start_time = time.time()
    bf_indices, bf_distances = ivf.brute_force_search(query_point, k=5, data=data)
    bf_time = time.time() - start_time
    
    # 6. æ˜¾ç¤ºç»“æœ
    print(f"\næœç´¢ç»“æœå¯¹æ¯”:")
    print(f"IVFæœç´¢  - æ‰¾åˆ°{len(ivf_indices)}ä¸ªæœ€è¿‘é‚», è€—æ—¶: {ivf_time:.6f}ç§’")
    print(f"æš´åŠ›æœç´¢ - æ‰¾åˆ°{len(bf_indices)}ä¸ªæœ€è¿‘é‚», è€—æ—¶: {bf_time:.6f}ç§’")
    
    print(f"\né€Ÿåº¦æå‡: {bf_time/ivf_time:.2f}å€")
    
    print(f"\næœ€è¿‘é‚»ç´¢å¼• (IVF): {ivf_indices}")
    print(f"æœ€è¿‘é‚»ç´¢å¼• (æš´åŠ›): {bf_indices}")
    
    # 7. æ£€æŸ¥å¬å›ç‡
    intersection = set(ivf_indices) & set(bf_indices)
    recall = len(intersection) / len(bf_indices)
    print(f"å¬å›ç‡: {recall:.2%} ({len(intersection)}/{len(bf_indices)})")
    
    return ivf, data, query_point, ivf_indices, bf_indices

# è¿è¡Œæ¼”ç¤º
ivf, data, query, ivf_results, bf_results = demonstrate_ivf()
```

ç»“æœè¾“å‡ºï¼š
```
============================================================
IVFç®—æ³•æ¼”ç¤º
============================================================
ç”Ÿæˆ300ä¸ªäºŒç»´æ•°æ®ç‚¹
å¼€å§‹è®­ç»ƒIVFç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œå¾—åˆ°3ä¸ªç°‡
å€’æ’ç´¢å¼•æ„å»ºå®Œæˆ:
  ç°‡2: 100ä¸ªå‘é‡
  ç°‡0: 100ä¸ªå‘é‡
  ç°‡1: 100ä¸ªå‘é‡

æŸ¥è¯¢ç‚¹: [5. 5.]

æœç´¢ç»“æœå¯¹æ¯”:
IVFæœç´¢  - æ‰¾åˆ°5ä¸ªæœ€è¿‘é‚», è€—æ—¶: 0.002092ç§’
æš´åŠ›æœç´¢ - æ‰¾åˆ°5ä¸ªæœ€è¿‘é‚», è€—æ—¶: 0.000437ç§’

é€Ÿåº¦æå‡: 0.21å€

æœ€è¿‘é‚»ç´¢å¼• (IVF): [258, 297, 172, 244, 116]
æœ€è¿‘é‚»ç´¢å¼• (æš´åŠ›): [258 297 172 244 116]
å¬å›ç‡: 100.00% (5/5)
```

**ğŸ“ˆ ç¬¬äº”æ­¥ï¼šå¯è§†åŒ–ç»“æœ**
è®©æˆ‘ä»¬ç”¨å›¾å½¢åŒ–çš„æ–¹å¼å±•ç¤ºIVFçš„å·¥ä½œåŸç†ï¼š

```python 
def visualize_ivf(ivf, data, query, ivf_results, bf_results):
    """å¯è§†åŒ–IVFç®—æ³•è¿‡ç¨‹"""
    plt.figure(figsize=(15, 5))
    
    # å­å›¾1: æ˜¾ç¤ºèšç±»ç»“æœ
    plt.subplot(1, 3, 1)
    colors = ['red', 'blue', 'green', 'purple', 'orange']
    
    # ç»˜åˆ¶æ¯ä¸ªç°‡çš„æ•°æ®ç‚¹
    for cluster_id, indices in ivf.inverted_lists.items():
        cluster_data = data[indices]
        plt.scatter(cluster_data[:, 0], cluster_data[:, 1], 
                   c=colors[cluster_id % len(colors)], alpha=0.6, 
                   label=f'ç°‡ {cluster_id}')
    
    # ç»˜åˆ¶è´¨å¿ƒ
    plt.scatter(ivf.centroids[:, 0], ivf.centroids[:, 1], 
               c='black', marker='x', s=200, linewidths=3, label='è´¨å¿ƒ')
    
    # ç»˜åˆ¶æŸ¥è¯¢ç‚¹
    plt.scatter(query[0], query[1], c='yellow', marker='*', 
               s=300, edgecolors='black', linewidth=2, label='æŸ¥è¯¢ç‚¹')
    
    plt.title('IVFèšç±»ç»“æœ')
    plt.xlabel('ç‰¹å¾ 1')
    plt.ylabel('ç‰¹å¾ 2')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # å­å›¾2: æ˜¾ç¤ºIVFæœç´¢ç»“æœ
    plt.subplot(1, 3, 2)
    
    # ç»˜åˆ¶æ‰€æœ‰æ•°æ®ç‚¹
    plt.scatter(data[:, 0], data[:, 1], c='lightgray', alpha=0.4, label='æ‰€æœ‰æ•°æ®')
    
    # é«˜äº®è¢«æœç´¢çš„ç°‡
    distances_to_centroids = euclidean_distances([query], ivf.centroids)[0]
    nearest_cluster_indices = np.argsort(distances_to_centroids)[:ivf.n_probe]
    
    for i, cluster_idx in enumerate(nearest_cluster_indices):
        cluster_data = data[ivf.inverted_lists[cluster_idx]]
        plt.scatter(cluster_data[:, 0], cluster_data[:, 1], 
                   c=colors[cluster_idx % len(colors)], alpha=0.8, 
                   label=f'æœç´¢ç°‡ {cluster_idx}')
    
    # ç»˜åˆ¶IVFæœç´¢ç»“æœ
    plt.scatter(data[ivf_results, 0], data[ivf_results, 1], 
               c='red', marker='o', s=100, edgecolors='darkred', 
               linewidth=2, label='IVFç»“æœ')
    
    plt.scatter(query[0], query[1], c='yellow', marker='*', 
               s=300, edgecolors='black', linewidth=2, label='æŸ¥è¯¢ç‚¹')
    
    plt.title(f'IVFæœç´¢ (n_probe={ivf.n_probe})')
    plt.xlabel('ç‰¹å¾ 1')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # å­å›¾3: æ˜¾ç¤ºæš´åŠ›æœç´¢ç»“æœçš„å¯¹æ¯”
    plt.subplot(1, 3, 3)
    plt.scatter(data[:, 0], data[:, 1], c='lightgray', alpha=0.4, label='æ‰€æœ‰æ•°æ®')
    plt.scatter(data[bf_results, 0], data[bf_results, 1], 
               c='green', marker='s', s=100, edgecolors='darkgreen', 
               linewidth=2, label='çœŸå®æœ€è¿‘é‚»')
    plt.scatter(data[ivf_results, 0], data[ivf_results, 1], 
               c='red', marker='o', s=80, alpha=0.8, label='IVFç»“æœ')
    plt.scatter(query[0], query[1], c='yellow', marker='*', 
               s=300, edgecolors='black', linewidth=2, label='æŸ¥è¯¢ç‚¹')
    
    plt.title('æœç´¢ç»“æœå¯¹æ¯”')
    plt.xlabel('ç‰¹å¾ 1')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()

# è¿è¡Œå¯è§†åŒ–
visualize_ivf(ivf, data, query, ivf_results, bf_results)
```
ç»“æœè¾“å‡ºï¼š
![alt text](/images/IVFç®—æ³•ç»“æœ.png)

**âš–ï¸ ç¬¬å…­æ­¥ï¼šå‚æ•°å½±å“åˆ†æ**
è®©æˆ‘ä»¬åˆ†æn_probeå‚æ•°å¯¹æœç´¢æ•ˆæœçš„å½±å“ï¼š

```python 
def analyze_parameters():
    """åˆ†æn_probeå‚æ•°å¯¹æœç´¢æ•ˆæœçš„å½±å“"""
    data = generate_sample_data(1000, 2)
    query = np.array([5.0, 5.0])
    
    n_probe_values = [1, 2, 3]
    results = []
    
    for n_probe in n_probe_values:
        ivf = SimpleIVF(n_clusters=5, n_probe=n_probe)
        ivf.data = data
        ivf.build_index(data)
        
        # IVFæœç´¢
        start_time = time.time()
        ivf_indices, _ = ivf.search(query, k=5, data=data)
        ivf_time = time.time() - start_time
        
        # æš´åŠ›æœç´¢ä½œä¸ºåŸºå‡†
        bf_indices, _ = ivf.brute_force_search(query, k=5, data=data)
        
        # è®¡ç®—å¬å›ç‡
        intersection = set(ivf_indices) & set(bf_indices)
        recall = len(intersection) / len(bf_indices)
        
        results.append({
            'n_probe': n_probe,
            'recall': recall,
            'time': ivf_time,
            'candidates_searched': sum(len(ivf.inverted_lists[i]) 
                                    for i in range(n_probe))
        })
    
    # æ˜¾ç¤ºç»“æœ
    print("\n" + "="*50)
    print("n_probeå‚æ•°å½±å“åˆ†æ")
    print("="*50)
    
    for result in results:
        print(f"n_probe={result['n_probe']}: "
              f"å¬å›ç‡={result['recall']:.1%}, "
              f"è€—æ—¶={result['time']:.6f}ç§’, "
              f"æœç´¢å‘é‡æ•°={result['candidates_searched']}")
    
    return results

# è¿è¡Œå‚æ•°åˆ†æ
parameter_results = analyze_parameters()
```

ç»“æœè¾“å‡ºï¼š
```
å§‹è®­ç»ƒIVFç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œå¾—åˆ°5ä¸ªç°‡
å€’æ’ç´¢å¼•æ„å»ºå®Œæˆ:
  ç°‡4: 333ä¸ªå‘é‡
  ç°‡1: 100ä¸ªå‘é‡
  ç°‡2: 110ä¸ªå‘é‡
  ç°‡3: 123ä¸ªå‘é‡
  ç°‡0: 334ä¸ªå‘é‡
å¼€å§‹è®­ç»ƒIVFç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œå¾—åˆ°5ä¸ªç°‡
å€’æ’ç´¢å¼•æ„å»ºå®Œæˆ:
  ç°‡0: 170ä¸ªå‘é‡
  ç°‡1: 163ä¸ªå‘é‡
  ç°‡3: 333ä¸ªå‘é‡
  ç°‡4: 150ä¸ªå‘é‡
  ç°‡2: 184ä¸ªå‘é‡
å¼€å§‹è®­ç»ƒIVFç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œå¾—åˆ°5ä¸ªç°‡
å€’æ’ç´¢å¼•æ„å»ºå®Œæˆ:
  ç°‡0: 333ä¸ªå‘é‡
  ç°‡2: 153ä¸ªå‘é‡
  ç°‡1: 180ä¸ªå‘é‡
  ç°‡4: 191ä¸ªå‘é‡
  ç°‡3: 143ä¸ªå‘é‡

==================================================
n_probeå‚æ•°å½±å“åˆ†æ
==================================================
n_probe=1: å¬å›ç‡=80.0%, è€—æ—¶=0.001708ç§’, æœç´¢å‘é‡æ•°=334
n_probe=2: å¬å›ç‡=80.0%, è€—æ—¶=0.000682ç§’, æœç´¢å‘é‡æ•°=333
n_probe=3: å¬å›ç‡=100.0%, è€—æ—¶=0.000797ç§’, æœç´¢å‘é‡æ•°=666
```

ä»ç»“è®ºæˆ‘ä»¬å¯ä»¥å‘ç°â€‹é€Ÿåº¦ä¸ç²¾åº¦çš„åŸºæœ¬æƒè¡¡å…³ç³»â€‹â€‹
1.ä» n_probe=2åˆ° n_probe=3çš„å˜åŒ–ï¼Œå®Œç¾ä½“ç°äº†IVFç®—æ³•ä¸­â€‹â€‹é€Ÿåº¦ä¸ç²¾åº¦çš„ç»å…¸æƒè¡¡â€‹â€‹ã€‚
- å½“ n_probeä»2å¢åŠ åˆ°3æ—¶ï¼Œæœç´¢çš„ç°‡æ•°é‡å¢åŠ ï¼Œå› æ­¤éœ€è¦è®¡ç®—çš„å‘é‡æ•°é‡å‡ ä¹ç¿»å€ï¼ˆä»333å¢åŠ åˆ°666ï¼‰ã€‚è¿™å¯¼è‡´æœç´¢èŒƒå›´æ‰©å¤§ï¼Œä»è€Œâ€‹â€‹å¬å›ç‡ä»80%æå‡åˆ°äº†100%â€‹â€‹ï¼Œä½†ä»£ä»·æ˜¯â€‹â€‹è€—æ—¶ä¹Ÿæœ‰æ‰€å¢åŠ â€‹â€‹ï¼ˆä»0.000682ç§’å¢åŠ åˆ°0.000797ç§’ï¼‰ã€‚
è¿™è¯´æ˜ï¼Œâ€‹â€‹å¢å¤§ n_probeé€šå¸¸èƒ½ä»¥ç‰ºç‰²é€Ÿåº¦ä¸ºä»£ä»·æ¥æå‡å¬å›ç‡â€‹â€‹ã€‚

â€‹2.â€‹å‘ç°å¼‚å¸¸ç‚¹ï¼šn_probe=1çš„æ€§èƒ½åå¸¸â€‹â€‹
è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„å‘ç°ï¼Œè¿™ç†è®ºä¸Šï¼Œn_probe=1ï¼ˆåªæœç´¢1ä¸ªæœ€è¿‘çš„ç°‡ï¼‰åº”è¯¥æ˜¯æœ€å¿«çš„ï¼Œä½†ç»“æœå´æ˜¾ç¤ºå®ƒâ€‹â€‹æœ€æ…¢ï¼ˆ0.001708ç§’ï¼‰â€‹â€‹ã€‚
- åœ¨ n_probe=1æ—¶ï¼Œç”±äºç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚Pythonï¼‰çš„è§£é‡Šå™¨å¼€é”€ã€ç¼“å­˜æœªå‘½ä¸­æˆ–å…¶ä»–å¶ç„¶å› ç´ æ‰€è‡´ï¼Œä½ å¤šå°è¯•å‡ æ¬¡ä¼šå‘ç°n_probe=1çš„æ—¶é—´ä¼šæœ‰æ³¢åŠ¨ï¼Œè¿™å°±æ˜¯ç¼–è¯‘å™¨æœ¬èº«ç¼–è¯‘æˆ–è€…ç¼“å­˜å¯¼è‡´
â€‹
æœ€åï¼Œå¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹æ ¸å¿ƒè¦ç‚¹ï¼š

- åŸºæœ¬è§„å¾‹æˆç«‹â€‹â€‹ï¼šn_probeå¢å¤§ï¼Œæœç´¢èŒƒå›´æ‰©å¤§ï¼Œå¬å›ç‡æé«˜ï¼Œä½†è€—æ—¶å¢åŠ ã€‚
- â€‹â€‹å®è·µå‡ºçœŸçŸ¥â€‹â€‹ï¼šç†è®ºè§„å¾‹éœ€è¦åœ¨å®é™…æµ‹è¯•ä¸­éªŒè¯ã€‚å®éªŒä¸­å¯èƒ½ä¼šå‡ºç°åƒ n_probe=1è¿™æ ·çš„æ€§èƒ½å¼‚å¸¸ç‚¹ï¼Œè¿™æ­£ä½“ç°äº†å‚æ•°è°ƒä¼˜å’ŒåŸºå‡†æµ‹è¯•çš„é‡è¦æ€§ã€‚
- â€‹â€‹æ²¡æœ‰â€œæœ€å¥½â€çš„å‚æ•°ï¼Œåªæœ‰â€œæœ€åˆé€‚â€çš„å‚æ•°â€‹â€‹ï¼šæœ€ç»ˆçš„å‚æ•°é€‰æ‹©å–å†³äºåº”ç”¨åœºæ™¯å¯¹â€‹â€‹é€Ÿåº¦â€‹â€‹å’Œâ€‹â€‹ç²¾åº¦â€‹â€‹çš„å…·ä½“è¦æ±‚ã€‚