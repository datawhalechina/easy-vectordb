# Chapter 3ï¼šFAISS æ ¸å¿ƒåŠŸèƒ½è¿›é˜¶å­¦ä¹ æ•™ç¨‹

é€šè¿‡â€œç†è®ºè§£æ+æ ¸å¿ƒ API+å®æˆ˜æ¡ˆä¾‹â€çš„ç»“æ„ï¼Œå¸®åŠ©å¤§å®¶æŒæ¡å¤åˆç´¢å¼•è®¾è®¡ã€å‘é‡å½’ä¸€åŒ–ã€ç´¢å¼•æŒä¹…åŒ–åŠ GPU åŠ é€Ÿç­‰å…³é”®æŠ€èƒ½ï¼Œè§£å†³å¤§è§„æ¨¡å‘é‡æ£€ç´¢ä¸­çš„â€œç²¾åº¦-æ•ˆç‡â€å¹³è¡¡é—®é¢˜ã€‚

**å‰ç½®å‡†å¤‡**ï¼š

1. å®‰è£… FAISSï¼ˆCPU ç‰ˆæœ¬ï¼š`pip install faiss-cpu`ï¼›GPU ç‰ˆæœ¬ï¼š`pip install faiss-gpu`ï¼‰ï¼›
2. ä¸‹è½½ SIFT1M æ•°æ®é›†ï¼ˆå« 100 ä¸‡å¼ å›¾ç‰‡çš„ 128 ç»´ç‰¹å¾å‘é‡ï¼Œè·å–é“¾æ¥ï¼šhttps://huggingface.co/datasets/fzliu/sift1m/tree/mainï¼‰ï¼›
3. å¯¼å…¥ä¾èµ–åº“ï¼š`import faiss, numpy as np, time`ã€‚

## 1å‘é‡å½’ä¸€åŒ–ä¸ç›¸ä¼¼åº¦é€‚é…ï¼šé¿å…æ£€ç´¢åå·®

FAISS ä¸­ç›¸ä¼¼åº¦è®¡ç®—ä¾èµ–è·ç¦»åº¦é‡ï¼Œè€Œ COSINE ç›¸ä¼¼åº¦ï¼ˆè¡¡é‡å‘é‡æ–¹å‘ä¸€è‡´æ€§ï¼‰éœ€é€šè¿‡â€œL2 å½’ä¸€åŒ–â€é¢„å¤„ç†æ‰èƒ½æ­£ç¡®è®¡ç®—ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç»“æœåå·®ã€‚

### 1.1 æ ¸å¿ƒåŸç†ï¼šCOSINE ç›¸ä¼¼åº¦ä¸å½’ä¸€åŒ–çš„å…³ç³»

COSINE ç›¸ä¼¼åº¦ç”¨äºè¡¡é‡ä¸¤ä¸ªå‘é‡åœ¨æ–¹å‘ä¸Šçš„ä¸€è‡´æ€§ï¼Œå…¬å¼å¦‚ä¸‹ï¼š
$$
\text{cosine}(a,b) = \frac{a \cdot b}{\|a\| \|b\|}
$$
å…¶ä¸­ï¼Œ`a*bb`æ˜¯å‘é‡ `a` å’Œ `b` çš„å†…ç§¯ï¼Œ`|a|`å’Œ `|b|` æ˜¯å‘é‡ `a` å’Œ `b` çš„ L2 èŒƒæ•°ï¼ˆå³å‘é‡çš„é•¿åº¦ï¼‰ã€‚


#### 1.1.1 L2 å½’ä¸€åŒ–å¯¹ COSINE ç›¸ä¼¼åº¦çš„å½±å“

å¦‚æœæˆ‘ä»¬å¯¹å‘é‡ `a` å’Œ `b` è¿›è¡Œ **L2 å½’ä¸€åŒ–**ï¼ˆå³å°†å®ƒä»¬çš„èŒƒæ•°å½’ä¸€åŒ–ä¸º 1ï¼‰ï¼Œé‚£ä¹ˆï¼š
$$
\|a\| = 1, \quad \|b\| = 1
$$
æ­¤æ—¶ï¼ŒCOSINE ç›¸ä¼¼åº¦å°±ç®€åŒ–ä¸ºï¼š
$$
\text{cosine}(a,b) = a \cdot b
$$
ä¹Ÿå°±æ˜¯è¯´ï¼Œå½’ä¸€åŒ–åçš„å‘é‡ä¹‹é—´çš„ COSINE ç›¸ä¼¼åº¦ç›´æ¥ç­‰äºå®ƒä»¬çš„å†…ç§¯ã€‚

#### 1.1.2 L2 è·ç¦»ä¸ COSINE ç›¸ä¼¼åº¦çš„å…³ç³»

L2 è·ç¦»ï¼ˆå³æ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰å¯ä»¥é€šè¿‡ COSINE ç›¸ä¼¼åº¦è®¡ç®—å¾—åˆ°ï¼Œå…·ä½“å…³ç³»å¦‚ä¸‹ï¼š
$$
\|a - b\|^2 = 2(1 - \text{cosine}(a,b))
$$
ç”±æ­¤å¯è§ï¼ŒL2 è·ç¦»ä¸ COSINE ç›¸ä¼¼åº¦æ˜¯ **è´Ÿç›¸å…³** çš„ï¼šå½“ COSINE ç›¸ä¼¼åº¦è¶Šé«˜ï¼ŒL2 è·ç¦»è¶Šå°ã€‚

#### 1.1.3 ç»“è®º

1. åœ¨è®¡ç®— COSINE ç›¸ä¼¼åº¦æ—¶ï¼Œå¿…é¡»å…ˆå¯¹å‘é‡è¿›è¡Œ L2 å½’ä¸€åŒ–å¤„ç†ï¼ˆå³å°†å‘é‡çš„é•¿åº¦è§„èŒƒåŒ–ä¸º 1ï¼‰ã€‚
2. ä½¿ç”¨ COSINE ç›¸ä¼¼åº¦è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯ä»¥é€‰æ‹© **å†…ç§¯** æˆ– **L2 è·ç¦»** ä½œä¸ºåº¦é‡æ ‡å‡†ï¼Œå‰ææ˜¯å·²å¯¹å‘é‡è¿›è¡Œå½’ä¸€åŒ–ã€‚

### 1.2 æ ¸å¿ƒ APIï¼šfaiss.normalize_L2

```python
### å‡½æ•°ä½œç”¨ï¼šå¯¹çŸ©é˜µçš„æ¯è¡Œï¼ˆå‘é‡ï¼‰åš L2 å½’ä¸€åŒ–
faiss.normalize_L2(x)  # x ä¸º numpy æ•°ç»„ï¼ˆshape: NÃ—dï¼‰ï¼ŒåŸåœ°ä¿®æ”¹

# ç¤ºä¾‹
x = np.array([[1,2,3], [4,5,6]], dtype=np.float32)
faiss.normalize_L2(x)
print("å½’ä¸€åŒ–åå‘é‡ï¼š", x)
print("å½’ä¸€åŒ–åå‘é‡çš„ L2 èŒƒæ•°ï¼š", np.linalg.norm(x, axis=1))  # è¾“å‡º [1. 1.]
```

> å¦‚æœè¿è¡Œåè¾“å‡ºä¸æ˜¯ `[1. 1.]`ï¼Œå¤§æ¦‚ç‡æ˜¯ä»£ç æ‰§è¡Œæ—¶çš„ç²¾åº¦æ˜¾ç¤ºé—®é¢˜ï¼ˆå¦‚ `[1.0000001 0.9999999]`ï¼‰ï¼Œå±äºæµ®ç‚¹æ•°è®¡ç®—è¯¯å·®ï¼Œæœ¬è´¨ä»æ»¡è¶³å½’ä¸€åŒ–è¦æ±‚ï¼Œä¸å½±å“åç»­æ£€ç´¢é€»è¾‘ã€‚

### 1.3 å®æˆ˜ï¼šå½’ä¸€åŒ–å‰åæ£€ç´¢ç»“æœå¯¹æ¯”

**å®æˆ˜ç›®æ ‡**ï¼šä»¥ COSINE ç›¸ä¼¼åº¦ä¸ºç›®æ ‡ï¼Œå¯¹æ¯”â€œæœªå½’ä¸€åŒ–â€ä¸â€œå½’ä¸€åŒ–â€çš„æ£€ç´¢ç²¾åº¦å·®å¼‚ã€‚

```python
import faiss
import numpy as np

# 1. æ„é€ æµ‹è¯•æ•°æ®ï¼ˆ3 ä¸ªæ•°æ®åº“å‘é‡ï¼Œ2 ä¸ªæŸ¥è¯¢å‘é‡ï¼Œæ¨¡æ‹Ÿè¯­ä¹‰ç›¸ä¼¼æ€§ï¼‰
xb = np.array([[1,2,3], [2,4,6], [3,3,3]], dtype=np.float32)  # å‘é‡0ä¸å‘é‡1æ–¹å‘å®Œå…¨ä¸€è‡´ï¼ˆCOSINE=1ï¼‰ï¼Œå‘é‡2æ–¹å‘ç‹¬ç‰¹
xq = np.array([[0.5,1,1.5], [1,1,1]], dtype=np.float32)  # æŸ¥è¯¢0ä¸å‘é‡0/1æ–¹å‘ä¸€è‡´ï¼ŒæŸ¥è¯¢1ä¸å‘é‡2æ–¹å‘ä¸€è‡´
d = xb.shape[1]  # å‘é‡ç»´åº¦ï¼š3
k = 1  # æ£€ç´¢Top-1ç»“æœï¼ˆåªå–æœ€ç›¸ä¼¼çš„1ä¸ªï¼‰

# æ–¹æ¡ˆ 1ï¼šæœªå½’ä¸€åŒ–ï¼Œç”¨å†…ç§¯åº¦é‡ï¼ˆé”™è¯¯æ–¹å¼ï¼‰
index_no_norm = faiss.IndexFlatIP(d)  # å†…ç§¯ç´¢å¼•
index_no_norm.add(xb)  # åŠ å…¥æœªå½’ä¸€åŒ–çš„æ•°æ®åº“å‘é‡
D_no_norm, I_no_norm = index_no_norm.search(xq, k)  # æ£€ç´¢

# æ–¹æ¡ˆ 2ï¼šå½’ä¸€åŒ–åï¼Œç”¨å†…ç§¯åº¦é‡ï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
xb_norm = xb.copy()
xq_norm = xq.copy()
faiss.normalize_L2(xb_norm)  # æ•°æ®åº“å‘é‡å½’ä¸€åŒ–ï¼ˆæŒ‰è¡Œï¼‰
faiss.normalize_L2(xq_norm)  # æŸ¥è¯¢å‘é‡å¿…é¡»åŒæ­¥å½’ä¸€åŒ–ï¼ˆå…³é”®ï¼ï¼‰

index_norm = faiss.IndexFlatIP(d)
index_norm.add(xb_norm)
D_norm, I_norm = index_norm.search(xq_norm, k)

# è¾“å‡ºç»“æœå¯¹æ¯”
print("=== æ£€ç´¢ç»“æœå¯¹æ¯”ï¼ˆç›®æ ‡ï¼šCOSINE ç›¸ä¼¼åº¦ Top-1ï¼‰===")
print("æ•°æ®åº“å‘é‡ï¼š\n", xb)
print("æŸ¥è¯¢å‘é‡ 0ï¼š", xq[0], "ï¼ˆä¸æ•°æ®åº“å‘é‡0/1æ–¹å‘ä¸€è‡´ï¼ŒCOSINE=1ï¼‰")
print("æŸ¥è¯¢å‘é‡ 1ï¼š", xq[1], "ï¼ˆä¸æ•°æ®åº“å‘é‡2æ–¹å‘ä¸€è‡´ï¼‰")
print("\nã€æœªå½’ä¸€åŒ–+å†…ç§¯ã€‘æ£€ç´¢ç»“æœï¼ˆé”™è¯¯ï¼Œå—å‘é‡é•¿åº¦å¹²æ‰°ï¼‰ï¼š")
print(f"æŸ¥è¯¢0 æœ€ç›¸ä¼¼å‘é‡ç´¢å¼•ï¼š{I_no_norm[0][0]}ï¼Œå†…ç§¯ï¼š{D_no_norm[0][0]:.2f}")  
print(f"æŸ¥è¯¢1 æœ€ç›¸ä¼¼å‘é‡ç´¢å¼•ï¼š{I_no_norm[1][0]}ï¼Œå†…ç§¯ï¼š{D_no_norm[1][0]:.2f}")  

print("\nã€å½’ä¸€åŒ–+å†…ç§¯ã€‘æ£€ç´¢ç»“æœï¼ˆæ­£ç¡®ï¼Œå†…ç§¯=COSINEç›¸ä¼¼åº¦ï¼‰ï¼š")
print(f"æŸ¥è¯¢0 æœ€ç›¸ä¼¼å‘é‡ç´¢å¼•ï¼š{I_norm[0][0]}ï¼Œå†…ç§¯ï¼ˆCOSINEï¼‰ï¼š{D_norm[0][0]:.2f}")  
print(f"æŸ¥è¯¢1 æœ€ç›¸ä¼¼å‘é‡ç´¢å¼•ï¼š{I_norm[1][0]}ï¼Œå†…ç§¯ï¼ˆCOSINEï¼‰ï¼š{D_norm[1][0]:.2f}")  
```

**ç»“æœåˆ†æ**

æœªå½’ä¸€åŒ–æ—¶ï¼Œå†…ç§¯å—å‘é‡æ¨¡é•¿å½±å“ï¼ˆå‘é‡ 2 æ¨¡é•¿æ›´å¤§ï¼Œè™½ä¸æŸ¥è¯¢ 1 æ–¹å‘ä¸€è‡´ä½†å†…ç§¯æ›´é«˜ï¼‰ï¼Œå¯¼è‡´æ£€ç´¢é”™è¯¯ï¼›å½’ä¸€åŒ–åï¼Œå†…ç§¯ç›´æ¥ç­‰ä»·äº COSINE ç›¸ä¼¼åº¦ï¼Œç»“æœç¬¦åˆé¢„æœŸã€‚

## 2 ç´¢å¼•çš„ä¿å­˜ä¸åŠ è½½ï¼šé€‚é…å·¥ç¨‹åŒ–éƒ¨ç½²

å®é™…åº”ç”¨ä¸­ï¼Œç´¢å¼•è®­ç»ƒè€—æ—¶è¾ƒé•¿ï¼ˆç™¾ä¸‡çº§æ•°æ®éœ€åˆ†é’Ÿçº§ï¼‰ï¼Œéœ€å°†è®­ç»ƒå¥½çš„ç´¢å¼•â€œæŒä¹…åŒ–â€ä¿å­˜ï¼Œåœ¨çº¿æœåŠ¡æ—¶ç›´æ¥åŠ è½½ä½¿ç”¨ï¼Œé¿å…é‡å¤è®­ç»ƒã€‚

### 2.1 æ ¸å¿ƒ API ä¸ä¿å­˜æ ¼å¼

| API å‡½æ•°                                 | åŠŸèƒ½æè¿°                         | æ³¨æ„äº‹é¡¹                                   |
| :--------------------------------------- | :------------------------------- | :----------------------------------------- |
| `faiss.write_index(index, "index.path")` | å°†ç´¢å¼•åºåˆ—åŒ–ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶       | æ–‡ä»¶æ ¼å¼ä¸ºäºŒè¿›åˆ¶ï¼Œä¸å¯ç›´æ¥ç¼–è¾‘             |
| `faiss.read_index("index.path")`         | ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ç´¢å¼•ï¼Œè¿”å›ç´¢å¼•å¯¹è±¡ | åŠ è½½åå¯ç›´æ¥è°ƒç”¨ search æ–¹æ³•ï¼Œæ— éœ€é‡æ–°è®­ç»ƒ |

æ³¨æ„äº‹é¡¹ï¼š

1. ç´¢å¼•éœ€å®Œæˆè®­ç»ƒå’Œæ•°æ®æ·»åŠ åå†ä¿å­˜ï¼›
1. ä¿å­˜è·¯å¾„éœ€æœ‰å†™å…¥æƒé™ï¼Œå»ºè®®ç”¨ `.index` ä½œä¸ºåç¼€æ ‡è¯†ã€‚

### 2.2 å®æˆ˜ï¼šç¦»çº¿è®­ç»ƒç´¢å¼•ï¼Œåœ¨çº¿åŠ è½½æ£€ç´¢

**å®æˆ˜ç›®æ ‡**ï¼šæ¨¡æ‹Ÿâ€œç¦»çº¿è®­ç»ƒ-ä¿å­˜ç´¢å¼•-åœ¨çº¿åŠ è½½-æ£€ç´¢â€çš„å·¥ç¨‹åŒ–æµç¨‹ï¼ŒéªŒè¯ç´¢å¼•ä¿å­˜ä¸åŠ è½½çš„ä¸€è‡´æ€§ã€‚

**é˜¶æ®µ 1ï¼šç¦»çº¿è®­ç»ƒå¹¶ä¿å­˜ç´¢å¼•ï¼ˆç¦»çº¿ç¯å¢ƒï¼‰**

```python
import faiss
import numpy as np
import os
import time 
# 1. åŠ è½½ SIFT1M æ•°æ®åº“å‘é‡ï¼ˆä»…éœ€ xbï¼‰
def load_sift1m(path):
    # åŠ è½½æ–‡ä»¶ï¼ˆfvecs/ivecså‡ä¸ºäºŒè¿›åˆ¶æ ¼å¼ï¼ŒæŒ‰å¯¹åº” dtype è¯»å–ï¼‰
    xb = np.fromfile(f"{path}/sift_base.fvecs", dtype=np.float32)
    xq = np.fromfile(f"{path}/sift_query.fvecs", dtype=np.float32)
    gt = np.fromfile(f"{path}/sift_groundtruth.ivecs", dtype=np.int32)
    print(f"å‘é‡ç»´åº¦d: {d}")
    print("åŸå§‹æ•°æ®å½¢çŠ¶:", xb.shape, xq.shape, gt.shape)
    
    # ---------------------- è§£æ fvecs æ ¼å¼ï¼ˆæ•°æ®åº“/æŸ¥è¯¢å‘é‡ï¼‰----------------------
    # éªŒè¯æ•°æ®é•¿åº¦æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼ˆæ€»é•¿åº¦å¿…é¡»æ˜¯ (d+1) çš„æ•´æ•°å€ï¼‰
    assert xb.size % (d + 1) == 0, f"æ•°æ®åº“æ–‡ä»¶æŸåï¼šæ€»é•¿åº¦ {xb.size} ä¸æ˜¯ (d+1)={d+1} çš„æ•´æ•°å€"
    assert xq.size % (d + 1) == 0, f"æŸ¥è¯¢æ–‡ä»¶æŸåï¼šæ€»é•¿åº¦ {xq.size} ä¸æ˜¯ (d+1)={d+1} çš„æ•´æ•°å€"
    
    # é‡æ„ä¸º [å‘é‡æ•°, d+1]ï¼Œå†å»æ‰ç¬¬ä¸€åˆ—ï¼ˆç»´åº¦æ ‡è¯†ï¼‰ï¼Œå¾—åˆ°å®é™…å‘é‡
    xb = xb.reshape(-1, d + 1)[:, 1:]  # æ•°æ®åº“å‘é‡ï¼š(1000000, 128)
    xq = xq.reshape(-1, d + 1)[:, 1:]  # æŸ¥è¯¢å‘é‡ï¼š(10000, 128)
    
    # ---------------------- è§£æ ivecs æ ¼å¼ï¼ˆçœŸå®è¿‘é‚»ï¼‰----------------------
    # ivecs æ ¼å¼ï¼šæ¯ä¸ªè¿‘é‚»ç»„ = [4å­—èŠ‚è¿‘é‚»æ•°k] + [kä¸ª4å­—èŠ‚int32è¿‘é‚»ID]
    # 1. è·å–æ¯ä¸ªæŸ¥è¯¢çš„è¿‘é‚»æ•°kï¼ˆSIFT1Mçš„groundtruthé€šå¸¸æ˜¯æ¯ä¸ªæŸ¥è¯¢100ä¸ªè¿‘é‚»ï¼‰
    k = int(gt[0])
    print(f"æ¯ä¸ªæŸ¥è¯¢çš„è¿‘é‚»æ•°k: {k}")
    
    # éªŒè¯æ•°æ®é•¿åº¦æ˜¯å¦ç¬¦åˆæ ¼å¼
    assert gt.size % (k + 1) == 0, f"è¿‘é‚»æ–‡ä»¶æŸåï¼šæ€»é•¿åº¦ {gt.size} ä¸æ˜¯ (k+1)={k+1} çš„æ•´æ•°å€"
    
    # é‡æ„ä¸º [æŸ¥è¯¢æ•°, k+1]ï¼Œå»æ‰ç¬¬ä¸€åˆ—ï¼ˆè¿‘é‚»æ•°æ ‡è¯†ï¼‰ï¼Œå¾—åˆ°å®é™…è¿‘é‚»ID
    gt = gt.reshape(-1, k + 1)[:, 1:]  # çœŸå®è¿‘é‚»ï¼š(10000, 100)
    
    print("è§£æåæ•°æ®å½¢çŠ¶:", xb.shape, xq.shape, gt.shape)
    return xb, xq, gt

# æµ‹è¯•åŠ è½½ï¼ˆæ³¨æ„è·¯å¾„ä½¿ç”¨ raw å­—ç¬¦ä¸²æˆ–åŒåæ–œæ ï¼‰
d = 128
nlist = 1024
m = 16 
nbits = 8
nprobe = 50
xb, xq, gt = load_sift1m(r"C:\Users\xiong\Desktop\easy-vecdb\easy-vecdb\data\sift")

# ---------------------- åˆ›å»ºå¹¶è®­ç»ƒIVF-PQç´¢å¼• ----------------------
# ç´¢å¼•æ ¼å¼ï¼šIVF{nlist},PQ{m}ï¼Œè·ç¦»åº¦é‡ç”¨L2ï¼ˆæ¬§å¼è·ç¦»ï¼‰
index = faiss.index_factory(d, f"IVF{nlist},PQ{m}", faiss.METRIC_L2)

# IVF-PQå¿…é¡»å…ˆè®­ç»ƒï¼ˆèšç±»ä¸­å¿ƒ+PQé‡åŒ–å™¨ï¼‰ï¼Œè®­ç»ƒæ•°æ®éœ€è¶³å¤Ÿå¤šï¼ˆSIFT1Mæ»¡è¶³ï¼‰
print("å¼€å§‹è®­ç»ƒIVF-PQç´¢å¼•...")
index.train(xb)
print("è®­ç»ƒå®Œæˆï¼Œå¼€å§‹æ·»åŠ æ•°æ®åº“å‘é‡...")

# æ·»åŠ å‘é‡åˆ°ç´¢å¼•ï¼ˆIVFä¼šå°†å‘é‡åˆ†é…åˆ°å¯¹åº”çš„èšç±»ä¸­å¿ƒï¼‰
index.add(xb)
print(f"å‘é‡æ·»åŠ å®Œæˆï¼šå…±æ·»åŠ  {index.ntotal} ä¸ªå‘é‡")

# è®¾ç½®æŸ¥è¯¢å‚æ•°nprobeï¼ˆå½±å“æŸ¥è¯¢æ€§èƒ½ï¼‰
index.nprobe = nprobe
print(f"æŸ¥è¯¢å‚æ•°nprobeè®¾ç½®ä¸ºï¼š{nprobe}")

# ---------------------- ä¿å­˜ç´¢å¼• ----------------------
index_path = "IVF_PQ.index"
faiss.write_index(index, index_path)

# è®¡ç®—ç´¢å¼•æ–‡ä»¶å¤§å°
index_size = os.path.getsize(index_path) / 1024 / 1024  # è½¬ä¸ºMB
print(f"\nIVF-PQç´¢å¼•ä¿å­˜æˆåŠŸï¼")
print(f"ç´¢å¼•è·¯å¾„ï¼š{index_path}")
print(f"ç´¢å¼•å¤§å°ï¼š{np.round(index_size, 2)} MB")
```

è¿è¡Œç»“æœï¼š

```
å‘é‡ç»´åº¦d: 128
åŸå§‹æ•°æ®å½¢çŠ¶: (129000000,) (1290000,) (1010000,)
æ¯ä¸ªæŸ¥è¯¢çš„è¿‘é‚»æ•°k: 100
è§£æåæ•°æ®å½¢çŠ¶: (1000000, 128) (10000, 128) (10000, 100)
å¼€å§‹è®­ç»ƒIVF-PQç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œå¼€å§‹æ·»åŠ æ•°æ®åº“å‘é‡...
å‘é‡æ·»åŠ å®Œæˆï¼šå…±æ·»åŠ  1000000 ä¸ªå‘é‡
æŸ¥è¯¢å‚æ•°nprobeè®¾ç½®ä¸ºï¼š50

IVF-PQç´¢å¼•ä¿å­˜æˆåŠŸï¼
ç´¢å¼•è·¯å¾„ï¼šIVF_PQ.index
ç´¢å¼•å¤§å°ï¼š23.52 MB
```

**é˜¶æ®µ 2ï¼šåœ¨çº¿åŠ è½½å¹¶æ£€ç´¢ï¼ˆåœ¨çº¿æœåŠ¡ç¯å¢ƒï¼‰**

```python
def calculate_recall(I_pred, I_true, k):
    """
    è®¡ç®—å¬å›ç‡ï¼šé¢„æµ‹ç»“æœä¸­å‘½ä¸­çœŸå®è¿‘é‚»çš„æ¯”ä¾‹
    å‚æ•°ï¼šI_pred-æ¨¡å‹é¢„æµ‹çš„ç´¢å¼•çŸ©é˜µï¼ŒI_true-ç²¾ç¡®ç»“æœçš„ç´¢å¼•çŸ©é˜µï¼Œk-è¿‘é‚»æ•°
    è¿”å›ï¼šå¹³å‡å¬å›ç‡
    """
    recall_list = []
    for i in range(len(I_pred)):
        pred_set = set(I_pred[i])
        true_set = set(I_true[i])
        hit = len(pred_set & true_set)
        recall = hit / k
        recall_list.append(recall)
    return np.mean(recall_list)


# è®¡ç®—ç´¢å¼•æ–‡ä»¶å¤§å°
index_size = os.path.getsize(index_path) / 1024 / 1024  # è½¬ä¸ºMB
print(f"\nIVF-PQç´¢å¼•ä¿å­˜æˆåŠŸï¼")
print(f"ç´¢å¼•è·¯å¾„ï¼š{index_path}")
print(f"ç´¢å¼•å¤§å°ï¼š{np.round(index_size, 2)} MB")

# 2. åŠ è½½å·²ä¿å­˜çš„ç´¢å¼•
index = faiss.read_index(index_path)
print("ç´¢å¼•åŠ è½½æˆåŠŸï¼Œæ˜¯å¦è®­ç»ƒå®Œæˆï¼š", index.is_trained)  # è¾“å‡º True

# 3. ç›´æ¥æ£€ç´¢ï¼ˆæ— éœ€é‡æ–°è®­ç»ƒï¼‰
k = 10
start_time = time.time()
D, I = index.search(xq[:100], k)
search_time = time.time() - start_time

# éªŒè¯ç²¾åº¦ï¼ˆä¸ç¦»çº¿è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
recall = calculate_recall(I, gt[:100], k)  # å¤ç”¨ç¬¬ä¸€ç« çš„ calc_recall å‡½æ•°
print(f"åœ¨çº¿æ£€ç´¢æ—¶é—´ï¼š{search_time:.8f}sï¼Œå¬å›ç‡ï¼š{recall:.4f}")
```

è¿è¡Œç»“æœ

```
ç´¢å¼•åŠ è½½æˆåŠŸï¼Œæ˜¯å¦è®­ç»ƒå®Œæˆï¼š True
åœ¨çº¿æ£€ç´¢æ—¶é—´ï¼š0.00416613sï¼Œå¬å›ç‡ï¼š0.9700
```

## 3 GPU åŠ é€Ÿ FAISSï¼šå®ç°é«˜æ€§èƒ½æ£€ç´¢ï¼ˆé€‰å­¦ï¼‰

FAISS æ”¯æŒ GPU åŠ é€Ÿï¼Œé€šè¿‡å¹¶è¡Œè®¡ç®—æå‡ç´¢å¼•è®­ç»ƒå’Œæ£€ç´¢é€Ÿåº¦ï¼ˆç™¾ä¸‡çº§æ•°æ®æ£€ç´¢å¯ä»ç§’çº§é™è‡³æ¯«ç§’çº§ï¼‰ï¼Œæ ¸å¿ƒä¾èµ– NVIDIA CUDA æ¶æ„ã€‚

**Tips:**å®˜æ–¹`faiss-gpu`pip wheel ä¸»è¦é¢å‘ Linuxï¼Œå¯¹ Windowsç³»ç»Ÿæ”¯æŒæ¯”è¾ƒå·®

> ä»¥ä¸‹å†…å®¹å»ºè®®åœ¨linuxç³»ç»Ÿä¸Šå­¦ä¹ ~

### 3.1 GPU ç‰ˆæœ¬å®‰è£…ä¸ç¯å¢ƒéªŒè¯

#### 3.1.1 å®‰è£…æ­¥éª¤

```bash
#ä½¿ç”¨Condaå®‰è£…ï¼ˆæ¨èï¼‰
# åˆ›å»ºå¹¶æ¿€æ´»ä¸€ä¸ªCondaç¯å¢ƒï¼ˆå¯é€‰ä½†æ¨èï¼‰
conda create -n faiss-gpu-env python=3.10
conda activate faiss-gpu-env

# å®‰è£…faiss-gpuåŒ…ï¼ˆä¼šè‡ªåŠ¨å®‰è£…å¯¹åº”çš„CUDAè¿è¡Œåº“ï¼‰
conda install -c pytorch -c nvidia faiss-gpu=1.11.0

#ä½¿ç”¨Pipå®‰è£…
#å¦‚æœä½ çš„ç³»ç»Ÿå·²ç»é…ç½®å¥½äº†CUDAç¯å¢ƒï¼Œä½¿ç”¨pipå®‰è£…ä¼šæ›´ç›´æ¥ã€‚
# åœ¨æ¿€æ´»çš„è™šæ‹Ÿç¯å¢ƒä¸­ï¼Œç›´æ¥ä½¿ç”¨pipå®‰è£…
pip install faiss-gpu

# å¦‚æœéœ€è¦æŒ‡å®šç‰¹å®šç‰ˆæœ¬ï¼Œä¾‹å¦‚
pip install faiss-gpu==1.7.1.post2
```

#### 3.1.2 ç¯å¢ƒéªŒè¯

```python
import faiss

# 1. æ£€æŸ¥ FAISS æ˜¯å¦æ”¯æŒ GPU
print("æ˜¯å¦æ”¯æŒ GPUï¼š", faiss.get_num_gpus() > 0)  # è¾“å‡º True è¡¨ç¤ºæ”¯æŒ
print("GPU æ•°é‡ï¼š", faiss.get_num_gpus())

# 2. éªŒè¯ GPU ç´¢å¼•åˆ›å»º
d = 128
index_gpu = faiss.IndexFlatL2(d)
# å°† CPU ç´¢å¼•è½¬æ¢ä¸º GPU ç´¢å¼•
res = faiss.StandardGpuResources()  # ç®¡ç† GPU èµ„æº
index_gpu = faiss.index_cpu_to_gpu(res, 0, index_gpu)  # 0 è¡¨ç¤ºä½¿ç”¨ç¬¬ 0 å— GPU
print("GPU ç´¢å¼•åˆ›å»ºæˆåŠŸï¼š", type(index_gpu))  # è¾“å‡º <class 'faiss.swigfaiss.GpuIndexFlatL2'>
```

è¿è¡Œç»“æœ

```
æ˜¯å¦æ”¯æŒ GPUï¼š True
GPU æ•°é‡ï¼š 8
GPU ç´¢å¼•åˆ›å»ºæˆåŠŸï¼š <class 'faiss.swigfaiss_avx512.GpuIndexFlat'>
```

### 3.2 IndexGPU ä½¿ç”¨ï¼šå•å¡ä¸å¤šå¡

#### 3.2.1 å•å¡ä½¿ç”¨ï¼ˆå¸¸ç”¨åœºæ™¯ï¼‰

```python
import faiss
import numpy as np
import time

# ===================== 1. åŸºç¡€é…ç½®ä¸GPUåˆå§‹åŒ– =====================
d = 128               # å‘é‡ç»´åº¦ï¼ˆéœ€ä¸ä½ çš„æ•°æ®ä¸€è‡´ï¼‰
n = 100000            # åŸºç¡€å‘é‡æ€»æ•°ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
nq = 100              # æŸ¥è¯¢å‘é‡æ•°
gpu_id = 0            # æŒ‡å®šGPUå¡å·
k = 10                # Top-kæ£€ç´¢ç»“æœ
nlist = 1000          # IVFåˆ†åŒºæ•°ï¼ˆæ ¸å¿ƒå‚æ•°ï¼šå»ºè®® n/1000 ~ n/100ï¼‰

# åˆå§‹åŒ–GPUèµ„æºï¼ˆå¯é€‰é™åˆ¶æ˜¾å­˜ï¼Œé¿å…OOMï¼‰
res = faiss.StandardGpuResources()
# res.setTempMemory(2 * 1024 * 1024 * 1024)  # é™åˆ¶ä¸´æ—¶æ˜¾å­˜2GB

# ===================== 2. ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆæ›¿æ¢ä¸ºçœŸå®æ•°æ®ï¼‰ =====================
np.random.seed(42)
# è®­ç»ƒæ•°æ®ï¼ˆIVFç±»ç´¢å¼•å¿…é¡»è®­ç»ƒï¼Œæ•°é‡â‰¥10*nlistï¼‰
train_data = np.random.random((max(10*nlist, 50000), d)).astype('float32')
# åŸºç¡€å‘é‡åº“ï¼ˆå¿…é¡»float32ï¼ŒFAISSå¼ºåˆ¶è¦æ±‚ï¼‰
base_data = np.random.random((n, d)).astype('float32')
# æŸ¥è¯¢å‘é‡
query_data = np.random.random((nq, d)).astype('float32')

# ===================== 3. æ„å»ºGPUç‰ˆIVF_FLATç´¢å¼•ï¼ˆæ ¸å¿ƒï¼‰ =====================
print("åˆ›å»ºCPUç‰ˆIVF_FLATç´¢å¼•...")
# æ­£ç¡®è¯­æ³•ï¼šIVF{nlist},Flatï¼ˆFlatè¡¨ç¤ºåŸå§‹å‘é‡å­˜å‚¨ï¼Œæ— é‡åŒ–ï¼‰
cpu_index = faiss.index_factory(
    d, 
    f"IVF{nlist},Flat",  # æ ¸å¿ƒï¼šIVF_FLATç»„åˆ
    faiss.METRIC_L2      # è·ç¦»åº¦é‡ï¼šL2æ¬§å¼è·ç¦»ï¼ˆå†…ç§¯éœ€æ”¹METRIC_INNER_PRODUCTï¼‰
)

# è½¬æ¢ä¸ºGPUç´¢å¼•ï¼ˆIVF_FLATå®Œç¾æ”¯æŒGPUï¼‰
gpu_index = faiss.index_cpu_to_gpu(res, gpu_id, cpu_index)

# å¯é€‰ï¼šè®¾ç½®IVFæ£€ç´¢æ—¶çš„nprobeï¼ˆæ¢ç´¢åˆ†åŒºæ•°ï¼Œè¶Šå¤§ç²¾åº¦è¶Šé«˜ã€é€Ÿåº¦è¶Šæ…¢ï¼Œé»˜è®¤1ï¼‰
gpu_index.nprobe = 10  # æ¨èå€¼ï¼šnlist/100 ~ nlist/10ï¼ˆå¦‚1000åˆ†åŒºè®¾10ï¼‰

# ===================== 4. è®­ç»ƒç´¢å¼•ï¼ˆIVFç±»å¿…é¡»è®­ç»ƒï¼‰ =====================
print("è®­ç»ƒIVF_FLATç´¢å¼•...")
start = time.time()
gpu_index.train(train_data)  # è®­ç»ƒæ•°æ®éœ€è¦†ç›–æ•°æ®åˆ†å¸ƒ
print(f"è®­ç»ƒå®Œæˆï¼Œè€—æ—¶ï¼š{time.time()-start:.2f}s")

# ===================== 5. æ·»åŠ å‘é‡åˆ°GPUç´¢å¼• =====================
print("æ·»åŠ å‘é‡åˆ°GPUç´¢å¼•...")
start = time.time()
gpu_index.add(base_data)
print(f"æ·»åŠ å®Œæˆï¼å…±{gpu_index.ntotal}ä¸ªå‘é‡ï¼Œè€—æ—¶ï¼š{time.time()-start:.2f}s")

# ===================== 6. æ‰§è¡ŒGPUæ£€ç´¢ï¼ˆæ— é‡åŒ–æŸå¤±ï¼Œç²¾åº¦æœ€é«˜ï¼‰ =====================
print(f"\næ‰§è¡ŒTop-{k}æ£€ç´¢ï¼ˆIVF_FLATï¼Œnlist={nlist}, nprobe={gpu_index.nprobe}ï¼‰...")
start = time.time()
# Dï¼šè·ç¦»çŸ©é˜µï¼ˆnqÃ—kï¼‰ï¼ŒIï¼šä¸‹æ ‡çŸ©é˜µï¼ˆnqÃ—kï¼‰
D, I = gpu_index.search(query_data, k)
print(f"æ£€ç´¢å®Œæˆï¼è€—æ—¶ï¼š{(time.time()-start)*1000:.2f}msï¼Œå¹³å‡æ¯æŸ¥è¯¢ï¼š{(time.time()-start)/nq*1000:.2f}ms")

# ===================== 7. è¾“å‡ºæ£€ç´¢ç»“æœ =====================
print("\n===== æ£€ç´¢ç»“æœç¤ºä¾‹ï¼ˆå‰5ä¸ªæŸ¥è¯¢çš„Top-5ï¼‰ =====")
for i in range(min(5, nq)):
    print(f"\næŸ¥è¯¢{i}ï¼š")
    print(f"  Top-5è·ç¦»å€¼ï¼š{np.round(D[i][:5], 4)}")
    print(f"  Top-5å¯¹åº”ä¸‹æ ‡ï¼š{I[i][:5]}")

# ===================== 8. å¯é€‰æ“ä½œï¼šä¿å­˜/åŠ è½½ç´¢å¼• =====================
# ä¿å­˜ç´¢å¼•ï¼ˆéœ€è½¬å›CPUï¼‰
# cpu_index_save = faiss.index_gpu_to_cpu(gpu_index)
# faiss.write_index(cpu_index_save, "ivf_flat_gpu.index")

# åŠ è½½ç´¢å¼•
# cpu_index_load = faiss.read_index("ivf_flat_gpu.index")
# gpu_index_load = faiss.index_cpu_to_gpu(res, gpu_id, cpu_index_load)
# gpu_index_load.nprobe = 10  # åŠ è½½åéœ€é‡æ–°è®¾ç½®nprobe
```

è¿è¡Œç»“æœ

```
åˆ›å»ºCPUç‰ˆIVF_FLATç´¢å¼•...
è®­ç»ƒIVF_FLATç´¢å¼•...
è®­ç»ƒå®Œæˆï¼Œè€—æ—¶ï¼š0.12s
æ·»åŠ å‘é‡åˆ°GPUç´¢å¼•...
æ·»åŠ å®Œæˆï¼å…±100000ä¸ªå‘é‡ï¼Œè€—æ—¶ï¼š0.03s

æ‰§è¡ŒTop-10æ£€ç´¢ï¼ˆIVF_FLATï¼Œnlist=1000, nprobe=10ï¼‰...
æ£€ç´¢å®Œæˆï¼è€—æ—¶ï¼š2.25msï¼Œå¹³å‡æ¯æŸ¥è¯¢ï¼š0.02ms

===== æ£€ç´¢ç»“æœç¤ºä¾‹ï¼ˆå‰5ä¸ªæŸ¥è¯¢çš„Top-5ï¼‰ =====

æŸ¥è¯¢0ï¼š
  Top-5è·ç¦»å€¼ï¼š[13.6454 13.842  14.5776 15.5522 15.6321]
  Top-5å¯¹åº”ä¸‹æ ‡ï¼š[85484 25642 90796 49942 86371]

æŸ¥è¯¢1ï¼š
  Top-5è·ç¦»å€¼ï¼š[14.1259 14.4648 14.8441 14.862  15.0519]
  Top-5å¯¹åº”ä¸‹æ ‡ï¼š[54264 27473 63050 59408 34882]

æŸ¥è¯¢2ï¼š
  Top-5è·ç¦»å€¼ï¼š[14.1538 14.5383 14.6415 14.9484 15.064 ]
  Top-5å¯¹åº”ä¸‹æ ‡ï¼š[ 9141 31778 17320 38208 71374]

æŸ¥è¯¢3ï¼š
  Top-5è·ç¦»å€¼ï¼š[14.0641 14.1665 14.6997 15.0549 15.2932]
  Top-5å¯¹åº”ä¸‹æ ‡ï¼š[43768 14788 53221 50936 50594]

æŸ¥è¯¢4ï¼š
  Top-5è·ç¦»å€¼ï¼š[11.2052 13.4151 14.39   14.4102 14.7487]
  Top-5å¯¹åº”ä¸‹æ ‡ï¼š[12642 65914 93744  8293 21985]

```

#### 3.2.2 å¤šå¡ä½¿ç”¨ï¼ˆå¤§è§„æ¨¡æ•°æ®åœºæ™¯ï¼‰

å¤šå¡é€šè¿‡â€œç´¢å¼•åˆ†ç‰‡â€å®ç°å¹¶è¡Œï¼Œå°†æ•°æ®åº“å‘é‡åˆ†é…åˆ°å¤šä¸ª GPU ä¸Šï¼Œæ£€ç´¢æ—¶è”åˆå„å¡ç»“æœã€‚

```python
import faiss
import numpy as np
import time
import math
import os

# ===================== 1. æ ¸å¿ƒé…ç½®ï¼ˆåŒGPU+å¤§è§„æ¨¡ï¼‰ =====================
# å‘é‡åŸºç¡€é…ç½®
d = 128                      # å‘é‡ç»´åº¦
total_base_num = 5_000_000   # æ€»å‘é‡æ•°ï¼ˆ500ä¸‡ï¼Œå¯æŒ‰éœ€è°ƒæ•´ï¼‰
nq = 1000                    # æŸ¥è¯¢å‘é‡æ•°
k = 20                       # Top-kæ£€ç´¢
gpu_ids = [0, 1]             # ç›®æ ‡GPUå¡å·

# IVF_FLATå…³é”®å‚æ•°
nlist = 5000                 # IVFåˆ†åŒºæ•°ï¼ˆ500ä¸‡â†’5000ï¼Œå»ºè®®æ€»å‘é‡æ•°/1000ï¼‰
nprobe = 50                  # æ£€ç´¢æ¢ç´¢åˆ†åŒºæ•°ï¼ˆnlist/100ï¼‰
batch_size = 100_000         # åˆ†æ‰¹æ·»åŠ æ‰¹æ¬¡å¤§å°ï¼ˆé¿å…æ˜¾å­˜çˆ†ç‚¸ï¼‰

# ===================== 2. å¼ºåˆ¶æŒ‡å®šåŒGPU=====================
# å…³é”®ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é™åˆ¶ä»…ä½¿ç”¨0ã€1å·GPUï¼ˆå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬ï¼‰
os.environ["CUDA_VISIBLE_DEVICES"] = ",".join(map(str, gpu_ids))
print(f"å·²æŒ‡å®šä½¿ç”¨GPUï¼š{gpu_ids}ï¼ˆCUDA_VISIBLE_DEVICES={os.environ['CUDA_VISIBLE_DEVICES']}ï¼‰")

# åˆå§‹åŒ–GPUèµ„æºï¼ˆå…¨å±€å•ä¾‹å³å¯ï¼Œå¤šGPUè‡ªåŠ¨å…±äº«ï¼‰
res = faiss.StandardGpuResources()
# é™åˆ¶GPUæ€»ä¸´æ—¶æ˜¾å­˜ï¼ˆåŒGPUå…±äº«ï¼Œ8GBè¶³å¤Ÿ500ä¸‡å‘é‡ï¼‰
res.setTempMemory(8 * 1024 * 1024 * 1024)

# ===================== 3. ç”Ÿæˆå¤§è§„æ¨¡æ¨¡æ‹Ÿæ•°æ® =====================
np.random.seed(42)
# è®­ç»ƒæ•°æ®ï¼ˆIVFå¿…é¡»è®­ç»ƒï¼Œæ•°é‡â‰¥10*nlistï¼‰
train_data = np.random.random((max(10*nlist, 500_000), d)).astype('float32')
# æŸ¥è¯¢æ•°æ®
query_data = np.random.random((nq, d)).astype('float32')

# ===================== 4. æ„å»ºIVF_FLATç´¢å¼• =====================
print("åˆ›å»ºCPUç‰ˆIVF_FLATç´¢å¼•...")
# æ ¸å¿ƒï¼šä»…ä¿ç•™åŸºç¡€IVF_FLATé…ç½®ï¼Œé¿å…ç‰ˆæœ¬æ•æ„Ÿå‚æ•°
cpu_index = faiss.index_factory(
    d, 
    f"IVF{nlist},Flat",
    faiss.METRIC_L2  # æ¬§å¼è·ç¦»ï¼ˆå†…ç§¯éœ€æ”¹METRIC_INNER_PRODUCT+å½’ä¸€åŒ–ï¼‰
)

# å¤šGPUå…‹éš†é…ç½®ï¼ˆä»…ä¿ç•™æ ¸å¿ƒshardå‚æ•°ï¼Œç§»é™¤æ‰€æœ‰æ•æ„ŸAPIï¼‰
cloner = faiss.GpuMultipleClonerOptions()
cloner.shard = True  # æŒ‰IVFåˆ†åŒºåˆ†ç‰‡åˆ°åŒGPUï¼ˆå¹¶è¡Œæ•ˆç‡æœ€é«˜ï¼‰
cloner.useFloat16 = False  # ç¦ç”¨float16ï¼Œä¿è¯IVF_FLATç²¾åº¦
# ç§»é™¤æ‰€æœ‰GpuDeviceParamsç›¸å…³é…ç½®ï¼ˆæ— éœ€æ‰‹åŠ¨æŒ‡å®šè®¾å¤‡ï¼‰

# åˆ†å‘ç´¢å¼•åˆ°åŒGPUï¼ˆå…¼å®¹æ‰€æœ‰FAISSç‰ˆæœ¬çš„æœ€ç®€å†™æ³•ï¼‰
print("å°†ç´¢å¼•åˆ†å‘åˆ°æŒ‡å®šåŒGPU...")
gpu_index = faiss.index_cpu_to_all_gpus(
    cpu_index,
    cloner  # ä»…ä¼ é€’åˆ†ç‰‡é…ç½®ï¼Œæ— éœ€å…¶ä»–å‚æ•°
)

# è®¾ç½®æ£€ç´¢å‚æ•°ï¼ˆæå‡ç²¾åº¦ï¼‰
gpu_index.nprobe = nprobe

# ===================== 5. è®­ç»ƒç´¢å¼•ï¼ˆåŒGPUè‡ªåŠ¨å¹¶è¡Œï¼‰ =====================
print(f"è®­ç»ƒIVF_FLATç´¢å¼•ï¼ˆnlist={nlist}ï¼‰...")
start = time.time()
gpu_index.train(train_data)
train_time = time.time() - start
print(f"è®­ç»ƒå®Œæˆï¼è€—æ—¶ï¼š{train_time:.2f}s ({train_time/60:.1f}min)")

# ===================== 6. åˆ†æ‰¹æ·»åŠ å¤§è§„æ¨¡å‘é‡ =====================
print(f"åˆ†æ‰¹æ·»åŠ  {total_base_num} ä¸ªå‘é‡åˆ°åŒGPUç´¢å¼•...")
start = time.time()
total_batches = math.ceil(total_base_num / batch_size)

for batch_idx in range(total_batches):
    # è®¡ç®—æ‰¹æ¬¡èŒƒå›´
    start_idx = batch_idx * batch_size
    end_idx = min((batch_idx + 1) * batch_size, total_base_num)
    # ç”Ÿæˆå½“å‰æ‰¹æ¬¡å‘é‡ï¼ˆçœŸå®åœºæ™¯æ›¿æ¢ä¸ºæ–‡ä»¶/æ•°æ®åº“åŠ è½½ï¼‰
    batch_data = np.random.random((end_idx - start_idx, d)).astype('float32')
    
    # æ·»åŠ åˆ°åŒGPUç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ†ç‰‡ï¼‰
    gpu_index.add(batch_data)
    
    # æ‰“å°è¿›åº¦ï¼ˆæ¯10æ‰¹/æœ€åä¸€æ‰¹ï¼‰
    if (batch_idx + 1) % 10 == 0 or (batch_idx + 1) == total_batches:
        progress = (batch_idx + 1) / total_batches * 100
        elapsed = time.time() - start
        eta = (elapsed / (batch_idx + 1)) * (total_batches - batch_idx - 1)
        print(f"  æ‰¹æ¬¡ {batch_idx+1}/{total_batches} | è¿›åº¦ {progress:.1f}% | å·²è€—æ—¶ {elapsed:.2f}s | å‰©ä½™ {eta:.2f}s")

add_time = time.time() - start
print(f"\nâœ… æ‰€æœ‰å‘é‡æ·»åŠ å®Œæˆï¼ç´¢å¼•æ€»å‘é‡æ•°ï¼š{gpu_index.ntotal}")
print(f"æ·»åŠ è€—æ—¶ï¼š{add_time:.2f}s | å¹³å‡é€Ÿåº¦ï¼š{total_base_num/add_time:.0f} å‘é‡/ç§’")

# ===================== 7. åŒGPUå¹¶è¡Œæ£€ç´¢ =====================
print(f"\næ‰§è¡Œ {nq} ä¸ªæŸ¥è¯¢çš„Top-{k}æ£€ç´¢...")
start = time.time()
D, I = gpu_index.search(query_data, k)  # D=è·ç¦»ï¼ŒI=ä¸‹æ ‡
search_time = time.time() - start

# æ‰“å°æ£€ç´¢æ€§èƒ½
print(f"âœ… æ£€ç´¢å®Œæˆï¼")
print(f"æ€»è€—æ—¶ï¼š{search_time:.2f}s | å¹³å‡å•æŸ¥è¯¢è€—æ—¶ï¼š{search_time/nq*1000:.2f}ms")
print(f"QPSï¼ˆæŸ¥è¯¢/ç§’ï¼‰ï¼š{nq/search_time:.0f}")

# ===================== 8. æ£€ç´¢ç»“æœç¤ºä¾‹ =====================
print("\n===== æ£€ç´¢ç»“æœç¤ºä¾‹ï¼ˆå‰3ä¸ªæŸ¥è¯¢çš„Top-5ï¼‰ =====")
for i in range(min(3, nq)):
    print(f"\næŸ¥è¯¢{i} Top-5ç»“æœï¼š")
    print(f"  è·ç¦»å€¼ï¼š{np.round(D[i][:5], 4)}")
    print(f"  å‘é‡ä¸‹æ ‡ï¼š{I[i][:5]}")

# ===================== å¯é€‰ï¼šä¿å­˜/åŠ è½½ç´¢å¼• =====================
# # ä¿å­˜ç´¢å¼•ï¼ˆéœ€è½¬å›CPUï¼‰
# cpu_index_save = faiss.index_gpu_to_cpu(gpu_index)
# faiss.write_index(cpu_index_save, "ivf_flat_multi_gpu.index")

# # åŠ è½½ç´¢å¼•ï¼ˆé‡æ–°åˆ†å‘åˆ°åŒGPUï¼‰
# cpu_index_load = faiss.read_index("ivf_flat_multi_gpu.index")
# gpu_index_load = faiss.index_cpu_to_all_gpus(cpu_index_load, cloner)
# gpu_index_load.nprobe = nprobe
```

è¿è¡Œç»“æœ

```
å·²æŒ‡å®šä½¿ç”¨GPUï¼š[0, 1]ï¼ˆCUDA_VISIBLE_DEVICES=0,1ï¼‰
åˆ›å»ºCPUç‰ˆIVF_FLATç´¢å¼•...
å°†ç´¢å¼•åˆ†å‘åˆ°æŒ‡å®šåŒGPU...
è®­ç»ƒIVF_FLATç´¢å¼•ï¼ˆnlist=5000ï¼‰...
è®­ç»ƒå®Œæˆï¼è€—æ—¶ï¼š1.18s (0.0min)
åˆ†æ‰¹æ·»åŠ  5000000 ä¸ªå‘é‡åˆ°åŒGPUç´¢å¼•...
  æ‰¹æ¬¡ 10/50 | è¿›åº¦ 20.0% | å·²è€—æ—¶ 1.90s | å‰©ä½™ 7.61s
  æ‰¹æ¬¡ 20/50 | è¿›åº¦ 40.0% | å·²è€—æ—¶ 3.64s | å‰©ä½™ 5.46s
  æ‰¹æ¬¡ 30/50 | è¿›åº¦ 60.0% | å·²è€—æ—¶ 5.47s | å‰©ä½™ 3.65s
  æ‰¹æ¬¡ 40/50 | è¿›åº¦ 80.0% | å·²è€—æ—¶ 6.87s | å‰©ä½™ 1.72s
  æ‰¹æ¬¡ 50/50 | è¿›åº¦ 100.0% | å·²è€—æ—¶ 8.71s | å‰©ä½™ 0.00s

âœ… æ‰€æœ‰å‘é‡æ·»åŠ å®Œæˆï¼ç´¢å¼•æ€»å‘é‡æ•°ï¼š5000000
æ·»åŠ è€—æ—¶ï¼š8.71s | å¹³å‡é€Ÿåº¦ï¼š574213 å‘é‡/ç§’

æ‰§è¡Œ 1000 ä¸ªæŸ¥è¯¢çš„Top-20æ£€ç´¢...
âœ… æ£€ç´¢å®Œæˆï¼
æ€»è€—æ—¶ï¼š0.01s | å¹³å‡å•æŸ¥è¯¢è€—æ—¶ï¼š0.01ms
QPSï¼ˆæŸ¥è¯¢/ç§’ï¼‰ï¼š100019

===== æ£€ç´¢ç»“æœç¤ºä¾‹ï¼ˆå‰3ä¸ªæŸ¥è¯¢çš„Top-5ï¼‰ =====

æŸ¥è¯¢0 Top-5ç»“æœï¼š
  è·ç¦»å€¼ï¼š[14.6679 14.7715 15.0722 15.1892 15.4013]
  å‘é‡ä¸‹æ ‡ï¼š[2682022 2900803 3671489 3657717 1205812]

æŸ¥è¯¢1 Top-5ç»“æœï¼š
  è·ç¦»å€¼ï¼š[12.7389 13.1389 13.3704 13.5513 13.7122]
  å‘é‡ä¸‹æ ‡ï¼š[3727640 3850541 4201952 1708469 3119344]

æŸ¥è¯¢2 Top-5ç»“æœï¼š
  è·ç¦»å€¼ï¼š[11.8149 13.6595 13.8389 14.2032 14.2623]
  å‘é‡ä¸‹æ ‡ï¼š[4565741 2941061 4406194 4841445 2768614]

```

### 3.3 å®æˆ˜ï¼šCPU VS GPU

ä¸ºäº†èƒ½å……åˆ†ä½“ç°GPUåŠ é€Ÿçš„èƒ½åŠ›ï¼Œå®æˆ˜éƒ¨åˆ†ä½¿ç”¨flatç®—æ³•è¿›è¡Œå‘é‡æ£€ç´¢

```python
import faiss
import numpy as np
import time
import os

# ===================== 1. å•GPUé…ç½®ï¼ˆæ ¸å¿ƒç®€åŒ–ï¼‰ =====================
# åŸºç¡€é…ç½®
d = 128                      # å‘é‡ç»´åº¦
nq = 1000                    # æŸ¥è¯¢å‘é‡æ•°ï¼ˆå›ºå®šï¼Œä¿è¯å¯¹æ¯”å…¬å¹³ï¼‰
k = 20                       # Top-kæ£€ç´¢ï¼ˆæš´åŠ›æœç´¢è¿”å›ç²¾ç¡®ç»“æœï¼‰
gpu_id = 0                   # å•GPUå¡å·ï¼ˆå›ºå®šä¸º0ï¼‰
test_scales = [10_000, 100_000, 500_000]  # æµ‹è¯•æ•°æ®è§„æ¨¡ï¼ˆ1ä¸‡/10ä¸‡/50ä¸‡ï¼‰
repeat_times = 3             # é‡å¤æµ‹è¯•æ¬¡æ•°ï¼ˆå–å¹³å‡ï¼Œå‡å°‘è¯¯å·®ï¼‰

# å¼ºåˆ¶æŒ‡å®šä»…ä½¿ç”¨0å·GPUï¼ˆé¿å…å ç”¨å…¶ä»–å¡ï¼‰
os.environ["CUDA_VISIBLE_DEVICES"] = str(gpu_id)
os.environ["CUBLAS_WORKSPACE_CONFIG"] = ":4096:8"
print(f"å½“å‰ä½¿ç”¨å•GPUï¼š{gpu_id}ï¼ˆCUDA_VISIBLE_DEVICES={os.environ['CUDA_VISIBLE_DEVICES']}ï¼‰")

# åˆå§‹åŒ–å•GPUèµ„æºï¼ˆé™åˆ¶æ˜¾å­˜ï¼Œé¿å…OOMï¼‰
gpu_res = faiss.StandardGpuResources()
gpu_res.setTempMemory(4 * 1024 * 1024 * 1024)  # é™åˆ¶4GBä¸´æ—¶æ˜¾å­˜

# ===================== 2. æ€§èƒ½æµ‹è¯•æ ¸å¿ƒå‡½æ•°ï¼ˆå•GPUä¸“å±ï¼‰ =====================
def test_brute_force(
    vec_dim: int,
    base_num: int,
    query_num: int,
    top_k: int,
    device: str  # "cpu" / "gpu"
) -> dict:
    """
    æµ‹è¯•å•è®¾å¤‡æš´åŠ›æœç´¢æ€§èƒ½
    :return: æ€§èƒ½æŒ‡æ ‡+æ£€ç´¢ç»“æœï¼ˆç”¨äºéªŒè¯ï¼‰
    """
    # å›ºå®šéšæœºç§å­ï¼Œä¿è¯CPU/GPUä½¿ç”¨å®Œå…¨ç›¸åŒçš„æµ‹è¯•æ•°æ®
    np.random.seed(42)
    base_data = np.random.random((base_num, vec_dim)).astype('float32')
    query_data = np.random.random((query_num, vec_dim)).astype('float32')

    # 1. åˆ›å»ºæš´åŠ›æœç´¢ç´¢å¼•ï¼ˆå•GPUæç®€å†™æ³•ï¼‰
    if device == "cpu":
        index = faiss.IndexFlatL2(vec_dim)  # CPUæš´åŠ›ç´¢å¼•ï¼ˆL2æ¬§å¼è·ç¦»ï¼‰
    elif device == "gpu":
        # å•GPUï¼šCPUç´¢å¼•ç›´æ¥è½¬GPUï¼ˆæ ¸å¿ƒç®€åŒ–ç‚¹ï¼‰
        cpu_index = faiss.IndexFlatL2(vec_dim)
        index = faiss.index_cpu_to_gpu(gpu_res, gpu_id, cpu_index)
    else:
        raise ValueError(f"ä»…æ”¯æŒcpu/gpuï¼Œå½“å‰è¾“å…¥ï¼š{device}")

    # 2. æ·»åŠ å‘é‡åˆ°ç´¢å¼•
    index.add(base_data)

    # 3. é¢„çƒ­ï¼ˆé¿å…é¦–æ¬¡åˆå§‹åŒ–è€—æ—¶å¹²æ‰°ï¼‰
    if device == "gpu":
        index.search(query_data[:10], top_k)  # GPUé¢„çƒ­

    # 4. æ­£å¼æµ‹è¯•ï¼ˆå¤šæ¬¡è¿è¡Œå–å¹³å‡ï¼‰
    total_time = 0.0
    final_D, final_I = None, None
    for _ in range(repeat_times):
        start = time.time()
        D, I = index.search(query_data, top_k)
        total_time += (time.time() - start)
        final_D, final_I = D, I  # ä¿ç•™æœ€åä¸€æ¬¡ç»“æœç”¨äºéªŒè¯

    # 5. è®¡ç®—æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡
    avg_time = total_time / repeat_times  # å¹³å‡æ€»è€—æ—¶
    qps = query_num / avg_time            # æ¯ç§’æŸ¥è¯¢æ•°ï¼ˆQPSï¼‰
    per_query_ms = (avg_time / query_num) * 1000  # å•æŸ¥è¯¢è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰

    return {
        "avg_total_time": round(avg_time, 4),
        "qps": round(qps, 0),
        "per_query_ms": round(per_query_ms, 4),
        "D": final_D,  # è·ç¦»çŸ©é˜µï¼ˆéªŒè¯ç”¨ï¼‰
        "I": final_I   # ä¸‹æ ‡çŸ©é˜µï¼ˆéªŒè¯ç”¨ï¼‰
    }

# ===================== 4. ä¸»æµ‹è¯•æµç¨‹ï¼ˆå•GPU vs CPUï¼‰ =====================
if __name__ == "__main__":
    print("="*80)
    print("å•GPUï¼ˆ0å·å¡ï¼‰ vs CPU æš´åŠ›æœç´¢ï¼ˆFlatï¼‰æ€§èƒ½å¯¹æ¯”")
    print(f"é…ç½®ï¼šç»´åº¦={d} | æŸ¥è¯¢æ•°={nq} | Top-k={k} | é‡å¤æµ‹è¯•={repeat_times}æ¬¡")
    print(f"æµ‹è¯•è§„æ¨¡ï¼š{[f'{s:,}' for s in test_scales]} æ¡åŸºç¡€å‘é‡")
    print("="*80)

    # é€è§„æ¨¡æµ‹è¯•
    for scale in test_scales:
        print(f"\nğŸ“Š æµ‹è¯•è§„æ¨¡ï¼š{scale:,} æ¡åŸºç¡€å‘é‡")
        print("-" * 60)

        # 1. CPUæµ‹è¯•
        print("ğŸ”µ CPUæš´åŠ›æœç´¢ï¼š")
        cpu_perf = test_brute_force(d, scale, nq, k, "cpu")
        print(f"  å¹³å‡æ€»è€—æ—¶ï¼š{cpu_perf['avg_total_time']}s")
        print(f"  QPSï¼š{cpu_perf['qps']} æ¬¡/ç§’")
        print(f"  å•æŸ¥è¯¢è€—æ—¶ï¼š{cpu_perf['per_query_ms']}ms")

        # 2. å•GPUæµ‹è¯•
        print("ğŸŸ¢ å•GPUæš´åŠ›æœç´¢ï¼š")
        gpu_perf = test_brute_force(d, scale, nq, k, "gpu")
        print(f"  å¹³å‡æ€»è€—æ—¶ï¼š{gpu_perf['avg_total_time']}s")
        print(f"  QPSï¼š{gpu_perf['qps']} æ¬¡/ç§’")
        print(f"  å•æŸ¥è¯¢è€—æ—¶ï¼š{gpu_perf['per_query_ms']}ms")

        # 3. æ€§èƒ½å¯¹æ¯”
        print("ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ï¼š")
        speedup = round(cpu_perf['avg_total_time'] / gpu_perf['avg_total_time'], 2)
        qps_ratio = round(gpu_perf['qps'] / cpu_perf['qps'], 2)
        print(f"  GPUç›¸å¯¹CPUæé€Ÿï¼š{speedup}å€")
        print(f"  GPU QPSæ˜¯CPUçš„ï¼š{qps_ratio}å€")

```

è¿è¡Œç»“æœ

```
å½“å‰ä½¿ç”¨å•GPUï¼š0ï¼ˆCUDA_VISIBLE_DEVICES=0ï¼‰
================================================================================
å•GPUï¼ˆ0å·å¡ï¼‰ vs CPU æš´åŠ›æœç´¢ï¼ˆFlatï¼‰æ€§èƒ½å¯¹æ¯”
é…ç½®ï¼šç»´åº¦=128 | æŸ¥è¯¢æ•°=1000 | Top-k=20 | é‡å¤æµ‹è¯•=3æ¬¡
æµ‹è¯•è§„æ¨¡ï¼š['10,000', '100,000', '500,000'] æ¡åŸºç¡€å‘é‡
================================================================================

ğŸ“Š æµ‹è¯•è§„æ¨¡ï¼š10,000 æ¡åŸºç¡€å‘é‡
------------------------------------------------------------
ğŸ”µ CPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š0.1028s
  QPSï¼š9727.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š0.1028ms
ğŸŸ¢ å•GPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š0.0007s
  QPSï¼š1410166.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š0.0007ms
ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ï¼š
  GPUç›¸å¯¹CPUæé€Ÿï¼š146.86å€
  GPU QPSæ˜¯CPUçš„ï¼š144.97å€

ğŸ“Š æµ‹è¯•è§„æ¨¡ï¼š100,000 æ¡åŸºç¡€å‘é‡
------------------------------------------------------------
ğŸ”µ CPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š0.7115s
  QPSï¼š1405.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š0.7115ms
ğŸŸ¢ å•GPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š0.0027s
  QPSï¼š364500.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š0.0027ms
ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ï¼š
  GPUç›¸å¯¹CPUæé€Ÿï¼š263.52å€
  GPU QPSæ˜¯CPUçš„ï¼š259.43å€

ğŸ“Š æµ‹è¯•è§„æ¨¡ï¼š500,000 æ¡åŸºç¡€å‘é‡
------------------------------------------------------------
ğŸ”µ CPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š8.6476s
  QPSï¼š116.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š8.6476ms
ğŸŸ¢ å•GPUæš´åŠ›æœç´¢ï¼š
  å¹³å‡æ€»è€—æ—¶ï¼š0.0124s
  QPSï¼š80845.0 æ¬¡/ç§’
  å•æŸ¥è¯¢è€—æ—¶ï¼š0.0124ms
ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ï¼š
  GPUç›¸å¯¹CPUæé€Ÿï¼š697.39å€
  GPU QPSæ˜¯CPUçš„ï¼š696.94å€

```

GPU åŠ é€Ÿæ ¸å¿ƒé€»è¾‘ï¼šé€šè¿‡å¹¶è¡Œè®¡ç®—åŒæ—¶å¤„ç†å¤šä¸ªæŸ¥è¯¢å’Œå‘é‡è·ç¦»è®¡ç®—ï¼Œçªç ´ CPU å•çº¿ç¨‹ç“¶é¢ˆã€‚

## 4 å­¦ä¹ æ€»ç»“ä¸å¸¸è§é—®é¢˜

### 4.1 æ ¸å¿ƒèƒ½åŠ›åœ°å›¾

- å¤åˆç´¢å¼•ï¼šç”¨ `index_factory` ç»„åˆ IVF/HNSW/PQï¼Œé€šè¿‡ `nprobe` è°ƒä¼˜ç²¾åº¦ä¸æ•ˆç‡ï¼›
- å½’ä¸€åŒ–ï¼šCOSINE ç›¸ä¼¼åº¦å¿…åš L2 å½’ä¸€åŒ–ï¼Œè°ƒç”¨ `faiss.normalize_L2` å®ç°ï¼›
- æŒä¹…åŒ–ï¼š`write_index/read_index` å®ç°ç´¢å¼•ä¿å­˜ä¸åŠ è½½ï¼Œé€‚é…å·¥ç¨‹åŒ–ï¼›
- GPU åŠ é€Ÿï¼šé€šè¿‡ `index_cpu_to_gpu` è½¬æ¢ç´¢å¼•ï¼Œå¤šå¡ç”¨ `index_cpu_to_all_gpus`ã€‚

### 4.2 å¸¸è§é—®é¢˜è§£ç­”

- **Q1ï¼šç´¢å¼•è®­ç»ƒæ—¶æŠ¥é”™â€œindex not trainedâ€ï¼Ÿ** Aï¼šIVFã€PQã€HNSW ç­‰ç´¢å¼•éœ€å…ˆè°ƒç”¨ `train(xb)` æ–¹æ³•ï¼Œä¸”è®­ç»ƒæ•°æ®é‡éœ€å¤§äº IVF åˆ†åŒºæ•°ã€‚
- **Q2ï¼šGPU ç‰ˆæœ¬å®‰è£…å¤±è´¥ï¼Ÿ** Aï¼šæ£€æŸ¥ CUDA ç‰ˆæœ¬ä¸ FAISS ç‰ˆæœ¬å…¼å®¹æ€§ï¼Œå»ºè®®ç”¨ conda å®‰è£…æˆ–å‚è€ƒ [FAISS å®˜æ–¹å®‰è£…æŒ‡å—](https://github.com/facebookresearch/faiss/blob/main/INSTALL.md)ã€‚
- **Q3ï¼šæ£€ç´¢ç»“æœä¸ºç©ºï¼Ÿ** Aï¼šç¡®è®¤ç´¢å¼•å·²æ·»åŠ æ•°æ®ï¼ˆ`index.ntotal > 0`ï¼‰ï¼Œä¸” `nprobe` ä¸å°äº 1ã€‚