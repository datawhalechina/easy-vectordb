# Chapter 2 Milvus核心概念：数据模型与索引体系

## 2.1 学习目标

- 掌握Milvus的核心数据模型（数据库、集合、分区、字段、向量、数据行）及各组件的详细特性与约束规则
- 理解数据模型各层级的嵌套关系、依赖逻辑及多租户隔离机制
- 掌握Milvus索引的核心作用、底层原理与常见索引类型的技术特性
- 学会根据数据规模、精度需求、资源限制选择合适的索引类型与距离度量方式

## 2.2 Milvus核心数据模型

Milvus采用“多层级嵌套”的数据组织模型，从顶层到底层依次为：数据库（Database）→ 集合（Collection）→ 分区（Partition）→ 段（Segment）→ 字段（Field）→ 数据行（Row）。该模型通过清晰的层级划分实现数据的逻辑隔离、精细化管理与高效检索，各层级的核心定义、功能特性及关联关系如下：

### 2.2.1 数据库（Database）

数据库是Milvus中最高层级的逻辑命名空间，核心作用是实现不同业务场景、多租户的数据隔离与资源管控。它为下层的集合（Collection）提供独立的存储与操作边界，不同数据库内的资源（集合、索引等）互不干扰，支持多业务线在同一Milvus实例中并行运行。

核心特性与约束：

- 隔离机制：支持物理级数据隔离与资源组绑定，可通过RBAC权限控制实现租户级访问限制，保障数据安全
- 默认配置：系统默认提供“default”数据库，用户无需创建即可直接使用；自定义数据库数量默认限制为64个（集群级配置可调整）
- 适用场景：按业务线划分（如“电商推荐数据库”“智能文档检索数据库”），或按租户划分（如“企业A专属数据库”“企业B专属数据库”）

### 2.2.2 集合（Collection）

集合是Milvus中存储向量数据及关联元数据的基本单元，等价于传统关系型数据库中的“表”，但专为高维向量数据的存储与检索优化设计。每个集合必须通过Schema（模式）定义数据结构，所有插入的数据需严格遵循Schema规范，确保数据类型与字段约束的一致性。Schema支持动态特性，可在特定场景下提升集合的扩展性

核心特性与约束：

Schema依赖：必须显式定义Schema（数据模式），Schema是集合数据结构的“蓝图”，核心组成包括字段定义、字段约束、系统默认配置三大模块，是数据校验、存储优化与检索效率保障的基础。其中字段定义需明确字段名称、数据类型；字段约束包含是否为主键、是否非空、默认值、长度限制等；系统默认配置涵盖时间戳字段、动态字段开关等。Schema定义后需严格遵循，所有插入数据将通过Schema进行类型校验与约束检查，不满足条件的数据会被拒绝插入

- 字段要求：强制包含至少一个向量字段（存储高维特征向量），同时可配置多个标量字段（存储属性元数据）；每个集合有且仅有一个主键字段（标量类型），用于唯一标识数据行
- 层级关联：一个数据库下可创建多个集合（默认上限65535个），每个集合对应一个具体的业务数据集（如“商品向量集合”“用户行为向量集合”“文本嵌入向量集合”）
- 物理存储：集合的物理存储单元为“段（Segment）”，数据插入时会先写入内存段，满足阈值后自动持久化为磁盘段，段是索引构建与检索的最小物理单元

### 2.2.3 分区（Partition）

分区是集合的逻辑子单元，用于对集合内的数据按指定规则进行分组管理，本质是将一个集合的Schema复用至多个子数据集。通过分区可缩小检索时的数据扫描范围，提升查询效率，同时简化数据生命周期管理（如按分区清理过期数据）。

核心特性与约束：

- 分区方式：支持按业务属性（如商品类别：服装、电子产品、食品）、时间范围（如2024年1月、2024年2月）、哈希规则（按主键哈希均匀分布）划分；也可通过Partition Key实现自动路由，数据插入时按分区键值自动分配至对应分区
- 隔离与资源：分区支持物理级资源隔离，可绑定独立资源组；单个集合默认最大支持1024个分区，基于Partition Key的动态分区可支持更高租户规模（百万级）
- 核心价值：检索时可指定分区列表（Partition-aware Search），避免全集合扫描；支持按分区执行批量删除、备份等操作，降低数据管理成本

### 2.2.4 字段（Field）

字段是数据存储的最小单元，定义了数据的类型、属性约束及存储特性，所有字段均需在集合的Schema中预先定义（动态字段除外）。根据存储数据类型的不同，分为向量字段与标量字段两类，两类字段协同实现“向量检索+标量过滤”的混合检索能力。此外，Milvus还包含系统默认字段，同时支持字段级索引配置，进一步提升检索效率

1. 向量字段（必填）

专门用于存储高维向量数据（如文本嵌入向量、图像特征向量），是Milvus实现相似性检索的核心字段。

- 支持类型：FLOAT_VECTOR（浮点型向量，如float32，主流模型默认输出类型，适用绝大多数AI场景）、BINARY_VECTOR（二进制向量，仅存储0/1值，用于轻量化检索场景，存储成本与计算开销更低）
- 核心配置：必须指定向量维度（如768维对应BERT模型、1536维对应GPT模型、2048维对应ResNet-50模型），维度大小需与模型输出严格一致；FLOAT_VECTOR支持1-65536维，BINARY_VECTOR维度需为8的整数倍（如64维、128维）。此外，可配置向量存储参数，如是否启用压缩存储（适用于大规模FLOAT_VECTOR场景）
- 索引支持：向量字段是索引构建的核心对象，所有Milvus支持的索引类型（如IVF_FLAT、HNSW等）均针对向量字段创建；一个向量字段可创建多个不同类型的索引，但同一时间仅能有一个生效
- 标量字段（可选）

用于存储与向量关联的属性元数据，支持多种基础数据类型，可作为检索时的过滤条件（如价格≤1000、是否上架）。

- 支持类型：基础标量类型包括Int64（商品ID、用户ID等唯一标识）、Float64（价格、评分、相似度分值等数值型属性）、String/VARCHAR（商品名称、描述、标签等文本属性，VARCHAR需指定最大长度）、Bool（是否上架、是否推荐等布尔属性）、DATE（创建时间、更新时间等时间属性）；进阶类型包括Array（数组类型，如商品所属分类列表）、JSON（轻量结构化数据，如用户画像标签）
- 主键约束：必须指定一个标量字段作为主键，支持两种赋值方式——手动赋值（需保证唯一性）、自动生成（如自增Int64、UUID）；主键字段的值具有强唯一性，不可重复，且支持主键索引（默认自动创建），可通过主键快速定位单条数据
- 索引支持：主流标量类型（Int64、Float64、String/VARCHAR等）可创建标量索引，如BloomFilter（用于快速判空与去重）、Range Index（用于范围查询，如价格>1000）、Trie Index（用于String类型的前缀匹配查询）；标量索引与向量索引协同工作，可先通过标量索引过滤数据，再对剩余向量执行相似性检索，大幅提升混合检索效率
- 约束配置：可设置非空约束（字段值不可为NULL）、默认值约束（如将“是否上架”默认设为false）、长度约束（如VARCHAR(100)限制商品名称最长100字符），约束配置在Schema定义时生效，插入数据时自动校验

### 2.2.5 数据行（Row）

数据行是集合中实际存储的单条数据记录，对应Schema定义的一套完整字段值组合，即“主键值+向量值+其他标量值”的集合。每条数据行会通过分区规则分配至集合的某个分区，最终存储在对应分区的段（Segment）中。

示例：一条商品向量数据行

- {商品ID（主键）: 1001, 商品名称（String）: "华为手机", 价格（Float64）: 3999.0, 是否上架（Bool）: true, 向量（FLOAT_VECTOR）: [0.12, 0.34, ..., 0.56]（768维）}

核心特性：数据行的字段值必须匹配Schema定义的类型与约束；支持动态插入，但未启用动态字段时不允许新增Schema外的字段；删除数据行时需通过主键或分区批量删除。此外，Milvus默认会为每个数据行添加两个系统字段，无需在Schema中定义：① _row_id：系统生成的唯一行标识，用于内部数据定位；② _timestamp：数据插入时的时间戳，用于数据版本管理与时间范围过滤

### 2.2.6 数据模型层级关系与传统数据库对比

1. 层级关系总结（从顶层到底层）

Database（业务/租户隔离）→ Collection（Schema定义的数据集）→ Partition（数据集分组）→ Segment（物理存储单元）→ Field（数据最小单元）→ Row（单条数据记录）

核心关联逻辑：一个Database包含多个Collection，一个Collection包含多个Partition，一个Partition包含多个Segment，一个Segment包含多个Row，每个Row包含所有Field的具体值。

2. 与传统关系型数据库对比

| Milvus数据模型     | 传统关系型数据库（如MySQL） | 核心差异                                                     |
| :----------------- | :-------------------------- | :----------------------------------------------------------- |
| Database           | Database                    | 均为顶层命名空间，支持多租户隔离；Milvus新增资源组绑定能力   |
| Collection         | Table                       | 均为数据存储基本单元；Collection强制要求向量字段，依赖Schema定义 |
| Partition          | Partition                   | 均为表/集合的子单元；Milvus支持Partition Key自动路由，隔离粒度更细 |
| Field（向量+标量） | Column                      | Milvus新增向量字段类型，支持高维数据存储；主键字段为强制要求 |
| Row                | Row/Tuple                   | 均为单条数据记录；Milvus行必须包含向量值，支持混合检索       |

## 2.3 Milvus索引体系

索引是提升Milvus相似性检索性能的核心技术手段。未创建索引时，Milvus采用“暴力检索（Brute-force Search）”，需遍历所有向量计算距离，效率极低（亿级数据检索耗时分钟级）；创建索引后，通过预构建的索引结构缩小检索范围，可将亿级向量检索耗时缩短至毫秒级，实现高效相似性匹配。

### 2.3.1 索引的核心作用

- 降低检索延迟：通过索引结构快速定位候选相似向量，避免全量计算，核心目标是实现“海量数据+低延迟”检索
- 平衡精度与效率：不同索引类型在检索精度（召回率）与检索速度之间存在权衡，可根据业务需求灵活选择（如追求极致速度选HNSW，追求高精度选FLAT）
- 支持混合检索：索引与标量过滤协同工作，可先通过标量字段过滤缩小数据范围，再对剩余向量执行索引检索，进一步提升效率

### 2.3.2 Milvus常见索引类型

Milvus支持11种以上索引类型，核心分为“近似最近邻检索（ANN）索引”和“精确最近邻检索（NN）索引”两大类。其中ANN索引通过牺牲少量精度换取高效检索性能，是实际应用的主流；NN索引适用于小规模数据或高精度要求场景。

1. IVF_FLAT（最常用基础ANN索引）

- 原理：基于倒排文件（Inverted File）思想，先通过k-means算法将向量空间聚类为nlist个“聚类中心”；检索时先计算目标向量与各聚类中心的距离，选择距离最近的k个聚类中心（nprobe参数控制），再在这些中心包含的向量中执行暴力检索
- 特点：检索精度接近精确检索（召回率＞95%），性能稳定，内存占用适中；索引构建速度较快，无精度损失（聚类过程不改变向量值）
- 适用场景：中小规模向量数据（百万级-千万级），对精度要求较高、资源预算适中的场景（如电商商品检索、中小规模文档检索）
- 核心参数：nlist（聚类中心数量，建议值为数据量的平方根，如100万数据设为1024；nlist越大，聚类越细，检索精度越高但构建耗时越长）；nprobe（检索时探查的聚类中心数量，默认10，值越大精度越高但检索越慢）
- IVF_SQ8（内存优化型ANN索引）

- 原理：在IVF_FLAT基础上增加“标量量化（Scalar Quantization）”步骤，将向量的float32类型值压缩为int8类型，减少内存占用（压缩比约4:1）
- 特点：内存占用仅为IVF_FLAT的1/4，检索速度比IVF_FLAT快3-5倍；但量化过程会导致少量精度损失（召回率比IVF_FLAT低5%-10%）
- 适用场景：内存资源有限、对精度要求不极致的大规模场景（如海量用户行为向量检索、实时推荐系统）
- 核心参数：nlist（同IVF_FLAT）；quantization_type（量化类型，默认int8）
- HNSW（高性能ANN索引）

- 原理：基于层级导航小世界（Hierarchical Navigable Small Worlds）思想，构建多层跳表式图结构；底层包含所有向量节点，上层为稀疏的“捷径”节点；检索时从顶层开始快速导航至目标区域，再在底层精细检索
- 特点：检索速度极快（比IVF_FLAT快10-100倍），精度较高（召回率接近IVF_FLAT）；但索引构建耗时较长，内存占用较大（约为IVF_FLAT的2倍）
- 适用场景：大规模向量数据（千万级-亿级），对检索延迟要求严格的场景（如实时语义搜索、图像检索API服务）
- 核心参数：M（每层节点的连接数，建议8-64，M越大索引越密集，精度越高但速度越慢）；efConstruction（构建索引时的探查节点数，建议100-200，值越大构建质量越高但耗时越长）；ef（检索时的探查节点数，建议10-100，值越大精度越高但检索越慢）
- FLAT（精确NN索引）

- 原理：无索引结构，本质是将向量原始存储，检索时遍历所有向量计算距离，返回精确的Top-K结果
- 特点：检索精度100%（无召回损失），索引构建时间为0（无需预构建）；但检索速度极慢，随数据量增长呈线性下降
- 适用场景：小规模向量数据（万级以下）、对精度要求极高的测试场景（如算法模型效果验证）、数据量极少的边缘计算场景
- 核心参数：无（无需配置额外参数）

### 2.3.3 索引创建的核心注意事项

- 索引创建时机：支持“插入数据前”或“插入数据后”创建。建议插入数据后创建，避免插入过程中重复更新索引结构，降低插入效率；批量插入大量数据后，需先执行Flush操作（将内存数据持久化至磁盘）再创建索引
- 索引生效条件：创建索引后，必须调用“加载集合”（load_collection）接口将索引加载至内存，索引才能生效；支持按分区加载索引，进一步节省内存
- 索引与集合的关系：一个集合可创建多个索引（针对同一向量字段或不同向量字段），但同一时间仅能有一个索引生效；切换生效索引时需先卸载当前索引，再加载目标索引
- 索引参数调优：核心参数（如nlist、M、ef）需根据数据量、向量维度、业务精度/速度需求调整；建议通过小批量测试对比不同参数组合的召回率与延迟，选择最优配置；具体可参考Milvus官方参数调优指南
- 索引文件大小：可通过index_file_size参数控制索引分块大小（默认1GB），数据量较大时建议调小该值，避免单块索引过大导致加载失败

## 2.4 距离度量方式

距离度量方式是判断两个向量相似程度的核心标准，通过计算向量空间中两个向量的“距离”或“相似度”量化关联程度。不同类型的向量（文本、图像、音频）、不同模型编码的向量，需匹配对应的距离度量方式才能保证检索效果。Milvus支持多种距离度量方式，核心常用类型如下：

### 2.4.1 余弦距离（Cosine Distance）

- 原理：计算两个向量之间夹角的余弦值，取值范围[-1, 1]；值越接近1，向量夹角越小，语义/特征相似度越高；值接近-1时，相似度最低。本质是衡量向量的“方向一致性”，忽略向量的绝对大小（自动归一化）
- 适用场景：文本向量（如BERT、Sentence-BERT编码）、图像向量（如ResNet、ViT编码）等语义/特征匹配场景；适用于向量绝对值无实际业务意义的场景（如文本的语义相似性）

### 2.4.2 欧氏距离（L2 Distance）

- 原理：计算两个向量在空间中的直线距离（L2范数），取值范围[0, +∞)；值越小，向量在空间中的位置越近，相似度越高
- 适用场景：图像识别、目标检测等计算机视觉场景（图像向量的绝对值代表像素特征强度）；向量绝对值大小具有实际意义的场景（如用户行为强度向量）；大部分深度学习视觉模型的默认推荐度量方式

### 2.4.3 曼哈顿距离（L1 Distance）

- 原理：计算两个向量对应维度差值的绝对值之和（L1范数），取值范围[0, +∞)；值越小，相似度越高。相较于欧氏距离，对异常值更敏感，且计算复杂度更低
- 适用场景：低维向量数据（维度＜100）、对异常值敏感的场景（如异常检测、欺诈识别）、资源受限的边缘设备检索场景

### 2.4.4 其他常用度量方式

- 内积（Dot Product）：计算两个向量的点积，取值范围[-∞, +∞)；值越大，相似度越高。适用于已归一化的向量场景，计算速度比余弦距离快（无需额外归一化步骤）
- 汉明距离（Hamming Distance）：适用于二进制向量，计算两个向量对应位不同的数量；值越小，相似度越高。适用于轻量化检索场景（如指纹识别、低维特征匹配）

### 2.4.5 距离度量方式选择建议

- 优先遵循模型推荐：文本向量（BERT、Sentence-BERT、LLaMA）优先选余弦距离或内积；图像向量（ResNet、ViT、CLIP）优先选欧氏距离；二进制向量必须选汉明距离
- 结合业务场景判断：关注“语义/特征方向”忽略大小 → 余弦距离；关注“特征强度差异” → 欧氏距离；低维+异常敏感 → 曼哈顿距离；轻量化二进制向量 → 汉明距离
- 实验验证优化：若不确定最优方式，可通过同一批测试数据，分别计算不同度量方式的检索召回率、准确率，结合业务指标（如推荐点击率、检索准确率）选择最优解

## 2.5 本章小结

本章核心掌握Milvus数据模型与索引体系的核心逻辑，重点包括：

- 数据模型的六层结构（Database→Collection→Partition→Segment→Field→Row），各层级的定义、约束规则及关联逻辑；理解向量字段与标量字段的协同作用，掌握Schema设计的核心要求
- 多租户隔离机制在数据模型中的体现（数据库级、集合级、分区级），理解分区管理对检索效率与数据生命周期的价值
- 常见索引类型（IVF_FLAT、IVF_SQ8、HNSW、FLAT）的底层原理、特性差异及适用场景，掌握索引创建与调优的核心注意事项
- 主流距离度量方式的原理与适用场景，学会根据向量类型、模型输出、业务需求选择合适的度量方式

这些概念是后续Milvus实操（集合创建、数据插入、索引构建、相似性检索）的基础，需重点理解各组件的依赖关系与设计初衷，才能在实际业务中灵活设计数据结构与检索方案。